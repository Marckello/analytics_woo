
    <!DOCTYPE html>
    <html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Adaptoheal Analytics - Dashboard Inteligente</title>
        <link rel="icon" type="image/webp" href="https://www.adaptohealmx.com/wp-content/uploads/2025/05/favicon.webp">
        <link rel="shortcut icon" type="image/webp" href="https://www.adaptohealmx.com/wp-content/uploads/2025/05/favicon.webp">
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
          tailwind.config = {
            theme: {
              extend: {
                colors: {
                  'adaptoheal': {
                    50: '#f0f9ff',
                    100: '#e0f2fe', 
                    500: '#0ea5e9',
                    600: '#0284c7',
                    700: '#0369a1',
                    800: '#075985',
                    900: '#0c4a6e'
                  }
                }
              }
            }
          }
        </script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
        <style>
          @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
          body { font-family: 'Inter', sans-serif; }
          .glass-effect { 
            background: rgba(255, 255, 255, 0.8); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255, 255, 255, 0.2); 
          }
          .gradient-bg { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
          }
          .card-hover { 
            transition: all 0.3s ease; 
          }
          .card-hover:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); 
          }
          .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
          }
          @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
          }
        </style>
    </head>
    <body class="bg-gradient-to-br from-gray-50 to-blue-50 min-h-screen">
        <!-- Modern Header with Gradient - RESPONSIVE OPTIMIZADO -->
        <div class="gradient-bg shadow-xl">
            <div class="container mx-auto px-4 sm:px-6 py-4 sm:py-8">
                <!-- Header Principal: Logo y T√≠tulo -->
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-6 lg:space-y-0">
                    <div class="flex items-center space-x-3 sm:space-x-4">
                        <img src="https://www.adaptohealmx.com/wp-content/uploads/2025/05/Logo1-300x86.webp" 
                             alt="Adaptoheal M√©xico" 
                             class="h-8 sm:h-10 lg:h-12 w-auto">
                        <div>
                            <h1 class="text-lg sm:text-2xl lg:text-3xl font-bold text-white">Analytics Dashboard</h1>
                            <p class="text-blue-100 mt-1 text-xs sm:text-sm">Datos en tiempo real | An√°lisis Inteligente</p>
                        </div>
                    </div>
                    
                    <!-- User Info - M√≥vil en la misma l√≠nea -->
                    <div class="flex items-center justify-end space-x-3 lg:hidden">
                        <div class="text-right">
                            <p id="user-name-mobile" class="text-white text-sm font-medium">Usuario</p>
                            <p class="text-blue-100 text-xs">Dashboard</p>
                        </div>
                        
                        <!-- Admin Users Button (only for admins) -->
                        <button id="admin-users-btn-mobile" onclick="openUserManagement()" 
                                class="bg-blue-500/20 hover:bg-blue-500/30 text-white px-2 py-1 rounded-lg text-xs font-medium transition-all duration-200 border border-blue-400/20 hidden">
                            <i class="fas fa-users"></i>
                        </button>
                        
                        <button onclick="logout()" 
                                class="bg-white/20 hover:bg-white/30 text-white px-2 py-1 rounded-lg text-xs font-medium transition-all duration-200 border border-white/20">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Controles de Per√≠odo: Stack en m√≥vil, flex en desktop -->
                <div class="mt-6 lg:mt-4">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
                        <!-- SELECTORES DE PER√çODO -->
                        <div class="flex flex-col sm:flex-row sm:items-center space-y-3 sm:space-y-0 sm:space-x-4 lg:space-x-6">
                            <div class="flex flex-col sm:flex-row sm:items-center space-y-2 sm:space-y-0 sm:space-x-3">
                                <label class="text-white text-xs sm:text-sm font-medium whitespace-nowrap">Per√≠odo Principal:</label>
                                
                                <!-- Selector de per√≠odos predefinidos -->
                                <select id="period-selector" onchange="changePeriod()" 
                                        class="bg-white text-gray-800 border border-gray-300 rounded-lg px-3 py-2 text-xs sm:text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 hover:bg-gray-50 transition-all shadow-lg w-full sm:w-auto">
                                
                                <!-- Per√≠odos R√°pidos -->
                                <optgroup label="‚ö° Per√≠odos R√°pidos" style="color: #1f2937; font-weight: bold;">
                                    <option value="today" style="color: #1f2937; background: white;">üìÖ Hoy</option>
                                    <option value="yesterday" style="color: #1f2937; background: white;">üìÖ Ayer</option>
                                    <option value="last-7-days" style="color: #1f2937; background: white;">üìä √öltimos 7 d√≠as</option>
                                    <option value="last-30-days" style="color: #1f2937; background: white;">üìà √öltimos 30 d√≠as</option>
                                </optgroup>
                                
                                <!-- Per√≠odos Mensuales -->
                                <optgroup label="üìÜ Per√≠odos Mensuales" style="color: #1f2937; font-weight: bold;">
                                    <option value="this-month" style="color: #1f2937; background: white;">üìÖ Este mes</option>
                                    <option value="last-month" style="color: #1f2937; background: white;">üìÖ Mes anterior</option>
                                    <option value="august-2025" style="color: #1f2937; background: white;">üìä Agosto 2025</option>
                                    <option value="september-2025" selected style="color: #1f2937; background: white;">üìä Septiembre 2025</option>
                                    <option value="october-2025" style="color: #1f2937; background: white;">üìä Octubre 2025</option>
                                </optgroup>
                                
                                <!-- Datos Hist√≥ricos Excel -->
                                <optgroup label="üìä Datos Hist√≥ricos (2020-2025)" style="color: #1f2937; font-weight: bold;">
                                    <option value="historical-2025-h1" style="color: #1f2937; background: #e8f4fd;">üìä Primer Semestre 2025</option>
                                    <option value="historical-2024-full" style="color: #1f2937; background: #e8f4fd;">üìä Todo 2024</option>
                                    <option value="historical-2023-full" style="color: #1f2937; background: #e8f4fd;">üìä Todo 2023</option>
                                    <option value="historical-2022-full" style="color: #1f2937; background: #e8f4fd;">üìä Todo 2022</option>
                                    <option value="historical-2021-full" style="color: #1f2937; background: #e8f4fd;">üìä Todo 2021</option>
                                    <option value="historical-2020-full" style="color: #1f2937; background: #e8f4fd;">üìä Todo 2020</option>
                                    <option value="historical-all-time" style="color: #1f2937; background: #e8f4fd;">üöÄ Todo el Hist√≥rico (2020-2025)</option>
                                </optgroup>
                                
                                <!-- Rango Personalizado -->
                                <optgroup label="üîß Personalizado" style="color: #1f2937; font-weight: bold;">
                                    <option value="custom" style="color: #1f2937; background: white;">üìÖ Seleccionar fechas...</option>
                                </optgroup>
                            </select>
                        </div>
                        
                            <!-- Checkbox de comparaci√≥n simplificado -->
                            <div class="flex flex-col sm:flex-row sm:items-center space-y-2 sm:space-y-0 sm:space-x-3">
                                <label class="flex items-center space-x-2 cursor-pointer bg-white/10 hover:bg-white/20 rounded-lg px-3 py-2 transition-all duration-200 border border-white/20">
                                    <input type="checkbox" id="enable-comparison" onchange="toggleComparison()" checked
                                           class="rounded border-gray-300 text-purple-600 focus:ring-purple-500 focus:ring-offset-0">
                                    <span class="text-white text-xs sm:text-sm font-medium">
                                        <i class="fas fa-chart-line mr-1"></i>
                                        Activar comparaci√≥n
                                    </span>
                                </label>
                                
                                <!-- Indicador din√°mico del per√≠odo de comparaci√≥n -->
                                <div id="comparison-period-info" class="text-white text-xs bg-purple-500/20 px-3 py-2 rounded-lg border border-purple-400/30">
                                    <i class="fas fa-arrows-alt-h mr-1"></i>
                                    <span id="comparison-period-text">vs Per√≠odo anterior equivalente</span>
                                </div>
                            </div>
                        
                        </div>
                        
                        <!-- Panel de fechas personalizado (oculto por defecto) - RESPONSIVE -->
                        <div id="custom-date-panel" class="hidden flex flex-col sm:flex-row sm:items-center space-y-2 sm:space-y-0 sm:space-x-2 bg-white/20 backdrop-blur-sm rounded-lg px-3 py-2 border border-white/30 mt-3 lg:mt-0">
                            <div class="flex flex-col sm:flex-row sm:items-center space-y-2 sm:space-y-0 sm:space-x-2">
                                <label class="text-white text-xs font-medium">Desde:</label>
                                <input type="date" id="start-date" class="bg-white text-gray-800 border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 w-full sm:w-auto">
                                <label class="text-white text-xs font-medium">Hasta:</label>
                                <input type="date" id="end-date" class="bg-white text-gray-800 border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 w-full sm:w-auto">
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="applyCustomDates()" class="bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600 transition-colors">
                                    <i class="fas fa-check mr-1"></i>Aplicar
                                </button>
                                <button onclick="cancelCustomDates()" class="bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600 transition-colors">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Controles de Estado y Usuario - Desktop -->
                        <div class="hidden lg:flex items-center space-x-4">
                        
                            <div class="flex flex-col">
                                <div class="flex items-center space-x-2">
                                    <div class="pulse-dot w-3 h-3 bg-green-400 rounded-full"></div>
                                    <span class="text-white text-sm font-medium">Conectado en vivo</span>
                                </div>
                                <span class="text-white text-xs opacity-70 ml-5">WooCommerce API v3</span>
                            </div>
                            

                            <!-- User Info and Actions - Desktop Only -->
                            <div class="flex items-center space-x-3 border-l border-white/20 pl-4">
                                <div class="text-right">
                                    <p id="user-name" class="text-white text-sm font-medium">Usuario</p>
                                    <p class="text-blue-100 text-xs">Dashboard Adaptoheal</p>
                                </div>
                                
                                <!-- Admin Users Button (only for admins) -->
                                <button id="admin-users-btn" onclick="openUserManagement()" 
                                        class="bg-blue-500/20 hover:bg-blue-500/30 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 border border-blue-400/20 hidden">
                                    <i class="fas fa-users mr-1"></i>Usuarios
                                </button>
                                
                                <button onclick="logout()" 
                                        class="bg-white/20 hover:bg-white/30 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 border border-white/20">
                                    <i class="fas fa-sign-out-alt mr-1"></i>Salir
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FILTRO DE ESTADOS DE √ìRDENES -->
        <div class="bg-white shadow-lg border-t border-gray-200">
            <div class="container mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-filter text-gray-600"></i>
                            <span class="text-sm font-medium text-gray-700">Estados de √ìrdenes:</span>
                        </div>
                        
                        <!-- Checkboxes de Estados -->
                        <div class="flex items-center space-x-4 flex-wrap">
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="checkbox" id="status-completed" checked onchange="updateOrderStatusFilter()" 
                                       class="rounded border-gray-300 text-green-600 focus:ring-green-500">
                                <span class="text-xs font-medium text-gray-700">
                                    <span class="inline-block w-2 h-2 bg-green-500 rounded-full mr-1"></span>
                                    Completadas (<span id="count-completed">0</span>)
                                </span>
                            </label>
                            
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="checkbox" id="status-delivered" checked onchange="updateOrderStatusFilter()"
                                       class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="text-xs font-medium text-gray-700">
                                    <span class="inline-block w-2 h-2 bg-blue-500 rounded-full mr-1"></span>
                                    Entregadas (<span id="count-delivered">0</span>)
                                </span>
                            </label>
                            
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="checkbox" id="status-processing" checked onchange="updateOrderStatusFilter()"
                                       class="rounded border-gray-300 text-orange-600 focus:ring-orange-500">
                                <span class="text-xs font-medium text-gray-700">
                                    <span class="inline-block w-2 h-2 bg-orange-500 rounded-full mr-1"></span>
                                    En Proceso (<span id="count-processing">0</span>)
                                </span>
                            </label>
                            
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="checkbox" id="status-on-hold" checked onchange="updateOrderStatusFilter()"
                                       class="rounded border-gray-300 text-yellow-600 focus:ring-yellow-500">
                                <span class="text-xs font-medium text-gray-700">
                                    <span class="inline-block w-2 h-2 bg-yellow-500 rounded-full mr-1"></span>
                                    En Espera (<span id="count-on-hold">0</span>)
                                </span>
                            </label>
                            
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="checkbox" id="status-pending" checked onchange="updateOrderStatusFilter()"
                                       class="rounded border-gray-300 text-gray-600 focus:ring-gray-500">
                                <span class="text-xs font-medium text-gray-700">
                                    <span class="inline-block w-2 h-2 bg-gray-500 rounded-full mr-1"></span>
                                    Pendientes (<span id="count-pending">0</span>)
                                </span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Presets de WooCommerce -->
                    <div class="flex items-center space-x-2">
                        <span class="text-xs text-gray-500">Presets:</span>
                        <button onclick="applyWooCommercePreset()" 
                                class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-medium hover:bg-blue-200 transition-colors">
                            <i class="fab fa-wordpress mr-1"></i>WooCommerce
                        </button>
                        <button onclick="applyConservativePreset()" 
                                class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-medium hover:bg-green-200 transition-colors">
                            <i class="fas fa-shield-alt mr-1"></i>Conservador
                        </button>
                        <button onclick="applyAllStatusPreset()" 
                                class="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-xs font-medium hover:bg-purple-200 transition-colors">
                            <i class="fas fa-list mr-1"></i>Todos
                        </button>
                    </div>
                </div>
                
                <!-- INDICADOR DE PER√çODO ACTIVO -->
                <div class="border-t border-gray-100 bg-gray-50 py-2">
                    <div class="container mx-auto px-6">
                        <div class="flex items-center justify-between text-xs">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-calendar-alt text-gray-500"></i>
                                <span class="text-gray-600">Per√≠odo activo:</span>
                                <span id="active-period-display" class="font-medium text-gray-800 bg-blue-100 px-2 py-1 rounded">
                                    Cargando...
                                </span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-gray-500">Estados activos:</span>
                                <span id="active-statuses-display" class="font-medium text-gray-800">
                                    Completadas, Entregadas
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container mx-auto px-6 py-8 -mt-4">

            <!-- Modern Loading State -->
            <div id="loading" class="flex flex-col justify-center items-center py-16">
                <div class="relative">
                    <div class="animate-spin rounded-full h-16 w-16 border-4 border-blue-200"></div>
                    <div class="animate-spin rounded-full h-16 w-16 border-4 border-blue-600 border-t-transparent absolute top-0"></div>
                </div>
                <div class="mt-6 text-center">
                    <p class="text-lg font-medium text-gray-700">Conectando con WooCommerce</p>
                    <p class="text-sm text-gray-500 mt-2">Procesando datos de ventas... Esto puede tardar 10-15 segundos</p>
                    <div class="mt-4 flex items-center justify-center space-x-2">
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-blue-600 rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-blue-600 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-2 h-2 bg-blue-600 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        </div>
                        <span class="text-xs text-gray-400 ml-3">‚è±Ô∏è Tiempo estimado: 10-15 seg</span>
                    </div>
                </div>
            </div>

            <!-- Modern Dashboard Content -->
            <div id="dashboard" class="hidden space-y-8">
                <!-- Modern KPIs Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Ventas Card -->
                    <div class="glass-effect rounded-xl p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 rounded-lg bg-gradient-to-r from-green-500 to-emerald-600">
                                <i class="fas fa-chart-line text-xl text-white"></i>
                            </div>
                            <!-- Leyenda de per√≠odo removida - es redundante con el selector -->
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-600 mb-1">Ventas Totales</p>
                            <div class="flex items-center space-x-2">
                                <p id="total-sales" class="text-2xl font-bold text-gray-900">$0</p>
                                <div id="total-sales-change" class=""></div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">√öltimos 30 d√≠as</p>
                        </div>
                    </div>

                    <!-- Ticket Promedio Card -->
                    <div class="glass-effect rounded-xl p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 rounded-lg bg-gradient-to-r from-blue-500 to-cyan-600">
                                <i class="fas fa-receipt text-xl text-white"></i>
                            </div>
                            <span class="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-1 rounded-full">PROMEDIO</span>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-600 mb-1">Ticket Promedio</p>
                            <div class="flex items-center space-x-2">
                                <p id="avg-ticket" class="text-2xl font-bold text-gray-900">$0</p>
                                <div id="avg-ticket-change" class=""></div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Por orden completada</p>
                        </div>
                    </div>

                    <!-- √ìrdenes Card -->
                    <div class="glass-effect rounded-xl p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 rounded-lg bg-gradient-to-r from-purple-500 to-pink-600">
                                <i class="fas fa-shopping-bag text-xl text-white"></i>
                            </div>
                            <span class="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-1 rounded-full">TOTAL</span>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-600 mb-1">√ìrdenes Completadas</p>
                            <div class="flex items-center space-x-2">
                                <p id="orders-count" class="text-2xl font-bold text-gray-900">0</p>
                                <div id="orders-count-change" class=""></div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">√öltimos 30 d√≠as</p>
                        </div>
                    </div>

                    <!-- Ficha de conexi√≥n API eliminada - estado movido al header -->
                </div>

                <!-- NUEVA SECCI√ìN: Tipos de Cliente (Cliente vs Distribuidor) -->
                <div class="glass-effect rounded-xl p-8 card-hover">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-3">
                            <div class="p-3 rounded-lg bg-gradient-to-r from-purple-500 to-pink-600">
                                <i class="fas fa-users text-xl text-white"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">Tipos de Cliente</h3>
                                <p class="text-sm text-gray-600">Clasificaci√≥n exacta por email - 26 distribuidores identificados</p>
                            </div>
                        </div>
                        <span class="text-xs font-medium text-purple-600 bg-purple-100 px-3 py-1 rounded-full">
                            <i class="fas fa-check-circle mr-1"></i>EXACTO
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Distribuidores -->
                        <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-6 border border-purple-100">
                            <div class="flex items-center justify-between mb-4">
                                <div class="p-3 rounded-lg bg-gradient-to-r from-purple-500 to-pink-600">
                                    <i class="fas fa-crown text-xl text-white"></i>
                                </div>
                                <span id="distributors-percentage" class="text-xs font-bold text-purple-600 bg-purple-100 px-2 py-1 rounded-full">0%</span>
                            </div>
                            <div>
                                <div class="flex items-center justify-between">
                                    <p class="text-sm font-medium text-gray-600 mb-1">Distribuidores</p>
                                    <div id="distributors-sales-change" class=""></div>
                                </div>
                                <p id="distributors-sales" class="text-xl font-bold text-gray-900">$0 MXN</p>
                                <div class="mt-2 space-y-1">
                                    <p id="distributors-orders" class="text-xs text-gray-500">0 √≥rdenes</p>
                                    <p id="distributors-customers" class="text-xs text-purple-600">0 clientes √∫nicos</p>
                                    <p id="distributors-avg-ticket" class="text-xs text-gray-500">Ticket prom: $0</p>
                                    <p id="distributors-avg-customer" class="text-xs text-purple-600">Por distribuidor: $0</p>
                                </div>
                                <div class="mt-3 text-xs text-gray-400">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Clasificaci√≥n: Email en lista exacta de 26 distribuidores registrados
                                </div>
                            </div>
                        </div>
                        
                        <!-- Clientes Regulares -->
                        <div class="bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl p-6 border border-blue-100">
                            <div class="flex items-center justify-between mb-4">
                                <div class="p-3 rounded-lg bg-gradient-to-r from-blue-500 to-cyan-600">
                                    <i class="fas fa-user text-xl text-white"></i>
                                </div>
                                <span id="customers-percentage" class="text-xs font-bold text-blue-600 bg-blue-100 px-2 py-1 rounded-full">0%</span>
                            </div>
                            <div>
                                <div class="flex items-center justify-between">
                                    <p class="text-sm font-medium text-gray-600 mb-1">Clientes Regulares</p>
                                    <div id="customers-sales-change" class=""></div>
                                </div>
                                <p id="customers-sales" class="text-xl font-bold text-gray-900">$0 MXN</p>
                                <div class="mt-2 space-y-1">
                                    <p id="customers-orders" class="text-xs text-gray-500">0 √≥rdenes</p>
                                    <p id="customers-customers" class="text-xs text-blue-600">0 clientes √∫nicos</p>
                                    <p id="customers-avg-ticket" class="text-xs text-gray-500">Ticket prom: $0</p>
                                    <p id="customers-avg-customer" class="text-xs text-blue-600">Por cliente: $0</p>
                                </div>
                                <div class="mt-3 text-xs text-gray-400">
                                    <i class="fas fa-shopping-cart mr-1"></i>
                                    Compras regulares y tickets menores
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NUEVA SECCI√ìN: Google Analytics 4 -->
                <div class="glass-effect rounded-xl p-8 card-hover">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-3">
                            <div class="p-3 rounded-lg bg-gradient-to-r from-blue-500 to-purple-600">
                                <i class="fas fa-chart-line text-xl text-white"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">Google Analytics 4</h3>
                                <p class="text-sm text-gray-600">Tr√°fico web, p√°ginas populares y demograf√≠a</p>
                            </div>
                        </div>
                        <span class="text-xs font-medium text-blue-600 bg-blue-100 px-3 py-1 rounded-full">
                            <i class="fas fa-globe mr-1"></i>ANALYTICS
                        </span>
                    </div>
                    
                    <div id="analytics-section">
                        <!-- Loading state -->
                        <div id="analytics-loading" class="text-center py-8">
                            <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mb-3"></i>
                            <p class="text-sm text-gray-500">Cargando datos de Google Analytics...</p>
                        </div>
                        
                        <!-- Analytics content -->
                        <div id="analytics-content" class="hidden">
                            <!-- Usuarios -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-4 border border-blue-100">
                                    <div class="flex items-center space-x-3">
                                        <div class="p-2 bg-blue-500 rounded-lg">
                                            <i class="fas fa-users text-white text-sm"></i>
                                        </div>
                                        <div>
                                            <p class="text-xs font-medium text-gray-600">Usuarios Totales</p>
                                            <p id="ga4-total-users" class="text-xl font-bold text-gray-900">0</p>
                                            <p class="text-xs text-gray-500">√∫ltimos 7 d√≠as</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl p-4 border border-green-100">
                                    <div class="flex items-center space-x-3">
                                        <div class="p-2 bg-green-500 rounded-lg">
                                            <i class="fas fa-user-plus text-white text-sm"></i>
                                        </div>
                                        <div>
                                            <p class="text-xs font-medium text-gray-600">Nuevos Usuarios</p>
                                            <p id="ga4-new-users" class="text-xl font-bold text-gray-900">0</p>
                                            <p id="ga4-new-users-percentage" class="text-xs text-gray-500">0% del total</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-4 border border-purple-100">
                                    <div class="flex items-center space-x-3">
                                        <div class="p-2 bg-purple-500 rounded-lg">
                                            <i class="fas fa-user-check text-white text-sm"></i>
                                        </div>
                                        <div>
                                            <p class="text-xs font-medium text-gray-600">Usuarios Recurrentes</p>
                                            <p id="ga4-returning-users" class="text-xl font-bold text-gray-900">0</p>
                                            <p id="ga4-returning-percentage" class="text-xs text-gray-500">0% del total</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- P√°ginas m√°s visitadas -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                <div class="bg-gray-50 rounded-xl p-4">
                                    <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                        <i class="fas fa-fire text-orange-500 mr-2"></i>
                                        P√°ginas M√°s Visitadas
                                    </h4>
                                    <div id="ga4-top-pages" class="space-y-2">
                                        <!-- Se llenar√° din√°micamente -->
                                    </div>
                                </div>
                                
                                <!-- Demograf√≠a -->
                                <div class="bg-gray-50 rounded-xl p-4">
                                    <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                        <i class="fas fa-globe-americas text-blue-500 mr-2"></i>
                                        Top Pa√≠ses
                                    </h4>
                                    <div id="ga4-countries" class="space-y-2">
                                        <!-- Se llenar√° din√°micamente -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Fuentes de tr√°fico -->
                            <div class="bg-gray-50 rounded-xl p-4">
                                <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                    <i class="fas fa-share-alt text-green-500 mr-2"></i>
                                    Fuentes de Tr√°fico
                                </h4>
                                <div id="ga4-traffic-sources" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                                    <!-- Se llenar√° din√°micamente -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error state -->
                        <div id="analytics-error" class="hidden text-center py-8">
                            <i class="fas fa-exclamation-triangle text-3xl text-yellow-400 mb-3"></i>
                            <p class="text-sm text-gray-500">Error cargando datos de Google Analytics</p>
                            <p id="analytics-error-message" class="text-xs text-gray-400 mt-1"></p>
                        </div>
                    </div>
                </div>

                <!-- NUEVA SECCI√ìN: Google Ads -->
                <div class="glass-effect rounded-xl p-8 card-hover">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-3">
                            <div class="p-3 rounded-lg bg-gradient-to-r from-green-500 to-emerald-600">
                                <i class="fas fa-bullhorn text-xl text-white"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">Google Ads</h3>
                                <p class="text-sm text-gray-600">Campa√±as publicitarias, keywords y conversiones</p>
                            </div>
                        </div>
                        <span class="text-xs font-medium text-green-600 bg-green-100 px-3 py-1 rounded-full">
                            <i class="fas fa-ad mr-1"></i>PUBLICIDAD
                        </span>
                    </div>
                    
                    <div id="google-ads-section">
                        <!-- Loading state -->
                        <div id="ads-loading" class="text-center py-8">
                            <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mb-3"></i>
                            <p class="text-sm text-gray-500">Cargando datos de Google Ads...</p>
                        </div>
                        
                        <!-- Google Ads content -->
                        <div id="ads-content" class="hidden">
                            <!-- Resumen de Google Ads -->
                            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-6">
                                <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-4 border border-green-100">
                                    <div class="flex items-center justify-between mb-2">
                                        <i class="fas fa-dollar-sign text-green-600"></i>
                                        <span class="text-xs font-medium text-green-600">GASTO TOTAL</span>
                                    </div>
                                    <p id="ads-total-spend" class="text-2xl font-bold text-gray-900">$0</p>
                                    <p class="text-xs text-gray-500">Inversi√≥n publicitaria</p>
                                </div>
                                
                                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 border border-blue-100">
                                    <div class="flex items-center justify-between mb-2">
                                        <i class="fas fa-mouse-pointer text-blue-600"></i>
                                        <span class="text-xs font-medium text-blue-600">CLICS</span>
                                    </div>
                                    <p id="ads-total-clicks" class="text-2xl font-bold text-gray-900">0</p>
                                    <p class="text-xs text-gray-500">Clics totales</p>
                                </div>
                                
                                <div class="bg-gradient-to-r from-purple-50 to-violet-50 rounded-lg p-4 border border-purple-100">
                                    <div class="flex items-center justify-between mb-2">
                                        <i class="fas fa-eye text-purple-600"></i>
                                        <span class="text-xs font-medium text-purple-600">IMPRESIONES</span>
                                    </div>
                                    <p id="ads-total-impressions" class="text-2xl font-bold text-gray-900">0</p>
                                    <p class="text-xs text-gray-500">Veces mostrado</p>
                                </div>
                                
                                <div class="bg-gradient-to-r from-orange-50 to-amber-50 rounded-lg p-4 border border-orange-100">
                                    <div class="flex items-center justify-between mb-2">
                                        <i class="fas fa-target text-orange-600"></i>
                                        <span class="text-xs font-medium text-orange-600">CONVERSIONES</span>
                                    </div>
                                    <p id="ads-total-conversions" class="text-2xl font-bold text-gray-900">0</p>
                                    <p class="text-xs text-gray-500">Objetivos logrados</p>
                                </div>
                            </div>
                            
                            <!-- M√©tricas adicionales -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div class="bg-white rounded-lg p-4 border border-gray-100">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-medium text-gray-600">CTR Promedio</span>
                                        <i class="fas fa-percentage text-gray-400"></i>
                                    </div>
                                    <p id="ads-average-ctr" class="text-xl font-bold text-gray-900">0%</p>
                                </div>
                                
                                <div class="bg-white rounded-lg p-4 border border-gray-100">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-medium text-gray-600">Costo por Clic</span>
                                        <i class="fas fa-calculator text-gray-400"></i>
                                    </div>
                                    <p id="ads-cost-per-click" class="text-xl font-bold text-gray-900">$0</p>
                                </div>
                                
                                <div class="bg-white rounded-lg p-4 border border-gray-100">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-medium text-gray-600">Costo por Conversi√≥n</span>
                                        <i class="fas fa-funnel-dollar text-gray-400"></i>
                                    </div>
                                    <p id="ads-cost-per-conversion" class="text-xl font-bold text-gray-900">$0</p>
                                </div>
                            </div>
                            
                            <!-- Top Campa√±as y Keywords -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- Top Campa√±as -->
                                <div class="bg-white rounded-lg p-4 border border-gray-100">
                                    <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                        <i class="fas fa-bullhorn text-green-600 mr-2"></i>
                                        Top Campa√±as
                                    </h4>
                                    <div id="ads-top-campaigns" class="space-y-3">
                                        <!-- Se llenar√° din√°micamente -->
                                    </div>
                                </div>
                                
                                <!-- Top Keywords -->
                                <div class="bg-white rounded-lg p-4 border border-gray-100">
                                    <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                        <i class="fas fa-key text-blue-600 mr-2"></i>
                                        Top Keywords
                                    </h4>
                                    <div id="ads-top-keywords" class="space-y-3">
                                        <!-- Se llenar√° din√°micamente -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error state -->
                        <div id="ads-error" class="hidden text-center py-8">
                            <i class="fas fa-exclamation-triangle text-3xl text-yellow-400 mb-3"></i>
                            <p class="text-sm text-gray-500">Error cargando datos de Google Ads</p>
                            <p id="ads-error-message" class="text-xs text-gray-400 mt-1"></p>
                        </div>
                    </div>
                </div>

                <!-- NUEVA SECCI√ìN: Cupones de Descuento -->
                <div class="glass-effect rounded-xl p-8 card-hover">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-3">
                            <div class="p-3 rounded-lg bg-gradient-to-r from-orange-500 to-red-600">
                                <i class="fas fa-tags text-xl text-white"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">Cupones y Promociones</h3>
                                <p class="text-sm text-gray-600">Descuentos tradicionales y costos reales de env√≠o gratis</p>
                            </div>
                        </div>
                        <span class="text-xs font-medium text-orange-600 bg-orange-100 px-3 py-1 rounded-full">
                            <i class="fas fa-percent mr-1"></i>CUPONES
                        </span>
                    </div>
                    
                    <div id="coupons-section">
                        <!-- Loading state -->
                        <div id="coupons-loading" class="text-center py-8">
                            <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mb-3"></i>
                            <p class="text-sm text-gray-500">Cargando cupones...</p>
                        </div>
                        
                        <!-- No coupons state -->
                        <div id="coupons-empty" class="hidden text-center py-8">
                            <i class="fas fa-tags text-3xl text-gray-300 mb-3"></i>
                            <p class="text-sm text-gray-500">No se encontraron cupones en este per√≠odo</p>
                        </div>
                        
                        <!-- Coupons grid -->
                        <div id="coupons-grid" class="hidden grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                            <!-- Los cupones se cargar√°n aqu√≠ din√°micamente -->
                        </div>
                        
                        <!-- Resumen de cupones -->
                        <div id="coupons-summary" class="hidden mt-6 bg-gradient-to-r from-orange-50 to-red-50 rounded-xl p-4 border border-orange-100">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Total Descontado</p>
                                    <div class="flex items-center space-x-2">
                                        <p id="total-coupons-amount" class="text-xl font-bold text-gray-900">$0 MXN</p>
                                        <div id="total-coupons-change" class=""></div>
                                    </div>
                                    <p id="total-coupons-percentage" class="text-xs text-gray-500 mt-1">0% del total de ventas</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm font-medium text-gray-600">√ìrdenes con Cup√≥n</p>
                                    <p id="total-coupons-orders" class="text-xl font-bold text-orange-600">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECCI√ìN: Costos Reales e Insights de Env√≠o -->
                <div class="glass-effect rounded-xl p-8 card-hover">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-3">
                            <div class="p-3 rounded-lg bg-gradient-to-r from-blue-500 to-cyan-600">
                                <i class="fas fa-shipping-fast text-xl text-white"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">Costos Reales e Insights de Env√≠o</h3>
                                <p class="text-sm text-gray-600">Datos reales desde Envia.com y an√°lisis de carriers</p>
                            </div>
                        </div>
                        <span class="text-xs font-medium text-blue-600 bg-blue-100 px-3 py-1 rounded-full">
                            <i class="fas fa-truck mr-1"></i>ENVIA.COM
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Costo Real Total -->
                        <div class="bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl p-6 border border-blue-100">
                            <div class="flex items-center justify-between mb-4">
                                <div class="p-3 rounded-lg bg-gradient-to-r from-blue-500 to-cyan-600">
                                    <i class="fas fa-dollar-sign text-xl text-white"></i>
                                </div>
                                <span class="text-xs font-bold text-blue-600 bg-blue-100 px-2 py-1 rounded-full">REAL</span>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-600 mb-1">Costo Real Total</p>
                                <p id="shipping-total-real" class="text-xl font-bold text-gray-900">$0 MXN</p>
                                <div class="mt-2 space-y-1">
                                    <p id="shipping-orders-found" class="text-xs text-gray-500">0 env√≠os encontrados</p>
                                    <p id="shipping-avg-real" class="text-xs text-blue-600">Promedio: $0</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Top Env√≠o -->
                        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl p-6 border border-yellow-100">
                            <div class="flex items-center justify-between mb-4">
                                <div class="p-3 rounded-lg bg-gradient-to-r from-yellow-500 to-orange-600">
                                    <i class="fas fa-crown text-xl text-white"></i>
                                </div>
                                <span class="text-xs font-bold text-yellow-600 bg-yellow-100 px-2 py-1 rounded-full">TOP</span>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-600 mb-1">Env√≠o M√°s Costoso</p>
                                <p id="shipping-top-cost" class="text-lg font-bold text-gray-900">$0</p>
                                <div class="mt-2 space-y-1">
                                    <p id="shipping-top-order" class="text-xs text-gray-500">Orden: -</p>
                                    <p id="shipping-top-carrier" class="text-xs text-yellow-600">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Top √ìrdenes de Env√≠o Gratis M√°s Costosas -->
                    <div class="mt-6 bg-gradient-to-r from-red-50 to-pink-50 rounded-xl p-6 border border-red-100">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-trophy text-red-600 mr-2"></i>
                            Top 5 Env√≠os "Gratis" M√°s Costosos
                        </h4>
                        <div id="top-free-shipping-orders" class="space-y-3">
                            <!-- Se cargar√°n din√°micamente -->
                        </div>
                    </div>
                </div>

                <!-- SECCI√ìN COMBINADA: M√©todos de Pago y Estados de √ìrdenes -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- M√âTODOS DE PAGO -->
                    <div class="glass-effect rounded-xl p-8 card-hover">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center space-x-3">
                                <div class="p-3 rounded-lg bg-gradient-to-r from-indigo-500 to-purple-600">
                                    <i class="fas fa-credit-card text-xl text-white"></i>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800">M√©todos de Pago</h3>
                                    <p class="text-sm text-gray-600">Desglose por tipo de pago</p>
                                </div>
                            </div>
                            <span class="text-xs font-medium text-indigo-600 bg-indigo-100 px-3 py-1 rounded-full">
                                <i class="fas fa-chart-pie mr-1"></i>AN√ÅLISIS
                            </span>
                        </div>
                        
                        <div class="grid grid-cols-1 gap-4">
                            <!-- Stripe -->
                            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 border border-blue-100">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center space-x-3">
                                        <div class="p-2 rounded-lg bg-blue-500">
                                            <i class="fab fa-stripe text-sm text-white"></i>
                                        </div>
                                        <div>
                                            <div class="flex items-center justify-between">
                                                <p class="text-sm font-medium text-gray-600">Stripe (Tarjetas)</p>
                                                <div id="stripe-sales-change" class=""></div>
                                            </div>
                                            <p id="stripe-sales" class="text-lg font-bold text-gray-900">$0 MXN</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span id="stripe-percentage" class="text-xs font-bold text-blue-600 bg-blue-100 px-2 py-1 rounded-full">0%</span>
                                        <p id="stripe-orders" class="text-xs text-gray-500 mt-1">0 √≥rdenes</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- PayPal -->
                            <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl p-4 border border-yellow-100">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center space-x-3">
                                        <div class="p-2 rounded-lg bg-yellow-500">
                                            <i class="fab fa-paypal text-sm text-white"></i>
                                        </div>
                                        <div>
                                            <div class="flex items-center justify-between">
                                                <p class="text-sm font-medium text-gray-600">PayPal</p>
                                                <div id="paypal-sales-change" class=""></div>
                                            </div>
                                            <p id="paypal-sales" class="text-lg font-bold text-gray-900">$0 MXN</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span id="paypal-percentage" class="text-xs font-bold text-yellow-600 bg-yellow-100 px-2 py-1 rounded-full">0%</span>
                                        <p id="paypal-orders" class="text-xs text-gray-500 mt-1">0 √≥rdenes</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Transferencia -->
                            <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 border border-green-100">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center space-x-3">
                                        <div class="p-2 rounded-lg bg-green-500">
                                            <i class="fas fa-university text-sm text-white"></i>
                                        </div>
                                        <div>
                                            <div class="flex items-center justify-between">
                                                <p class="text-sm font-medium text-gray-600">Transferencia</p>
                                                <div id="transfer-sales-change" class=""></div>
                                            </div>
                                            <p id="transfer-sales" class="text-lg font-bold text-gray-900">$0 MXN</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span id="transfer-percentage" class="text-xs font-bold text-green-600 bg-green-100 px-2 py-1 rounded-full">0%</span>
                                        <p id="transfer-orders" class="text-xs text-gray-500 mt-1">0 √≥rdenes</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ESTADOS DE √ìRDENES -->
                    <div class="glass-effect rounded-xl p-8 card-hover">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center space-x-3">
                                <div class="p-3 rounded-lg bg-gradient-to-r from-emerald-500 to-teal-600">
                                    <i class="fas fa-tasks text-xl text-white"></i>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800">Estados de √ìrdenes</h3>
                                    <p class="text-sm text-gray-600">Desglose por estado de procesamiento</p>
                                </div>
                            </div>
                            <span class="text-xs font-medium text-emerald-600 bg-emerald-100 px-3 py-1 rounded-full">
                                <i class="fas fa-chart-bar mr-1"></i>ESTADOS
                            </span>
                        </div>
                        
                        <div class="grid grid-cols-1 gap-4">
                            <!-- Completed -->
                            <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 border border-green-100">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center space-x-3">
                                        <div class="p-2 rounded-lg bg-green-500">
                                            <i class="fas fa-check-circle text-sm text-white"></i>
                                        </div>
                                        <div>
                                            <div class="flex items-center space-x-2">
                                                <p class="text-sm font-medium text-gray-600">Completadas</p>
                                                <div id="completed-sales-change" class=""></div>
                                            </div>
                                            <p id="completed-sales" class="text-lg font-bold text-gray-900">$0 MXN</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span id="completed-percentage" class="text-xs font-bold text-green-600 bg-green-100 px-2 py-1 rounded-full">0%</span>
                                        <p id="completed-orders" class="text-xs text-gray-500 mt-1">0 √≥rdenes</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Delivered -->
                            <div class="bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl p-4 border border-blue-100">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center space-x-3">
                                        <div class="p-2 rounded-lg bg-blue-500">
                                            <i class="fas fa-truck text-sm text-white"></i>
                                        </div>
                                        <div>
                                            <div class="flex items-center space-x-2">
                                                <p class="text-sm font-medium text-gray-600">Entregadas</p>
                                                <div id="delivered-sales-change" class=""></div>
                                            </div>
                                            <p id="delivered-sales" class="text-lg font-bold text-gray-900">$0 MXN</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span id="delivered-percentage" class="text-xs font-bold text-blue-600 bg-blue-100 px-2 py-1 rounded-full">0%</span>
                                        <p id="delivered-orders" class="text-xs text-gray-500 mt-1">0 √≥rdenes</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Processing -->
                            <div class="bg-gradient-to-r from-orange-50 to-yellow-50 rounded-xl p-4 border border-orange-100">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center space-x-3">
                                        <div class="p-2 rounded-lg bg-orange-500">
                                            <i class="fas fa-clock text-sm text-white"></i>
                                        </div>
                                        <div>
                                            <div class="flex items-center space-x-2">
                                                <p class="text-sm font-medium text-gray-600">En Proceso</p>
                                                <div id="processing-sales-change" class=""></div>
                                            </div>
                                            <p id="processing-sales" class="text-lg font-bold text-gray-900">$0 MXN</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span id="processing-percentage" class="text-xs font-bold text-orange-600 bg-orange-100 px-2 py-1 rounded-full">0%</span>
                                        <p id="processing-orders" class="text-xs text-gray-500 mt-1">0 √≥rdenes</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- NUEVO LAYOUT: 2 Columnas (Chat + Analytics) -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                    <!-- COLUMNA IZQUIERDA: Chat IA -->
                    <div class="flex flex-col h-full">
                        <!-- Chat IA Card -->
                        <div class="glass-effect rounded-xl p-8 card-hover flex flex-col h-full min-h-[800px]">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center space-x-3">
                                    <div class="p-3 rounded-lg bg-gradient-to-r from-purple-500 to-indigo-600">
                                        <i class="fas fa-robot text-xl text-white"></i>
                                    </div>
                                    <div>
                                        <h2 class="text-xl font-bold text-gray-800">Consulta con IA</h2>
                                        <p class="text-sm text-gray-500">Analista especializado en datos de Adaptoheal</p>
                                    </div>
                                </div>
                                <span class="text-xs font-medium text-purple-600 bg-purple-100 px-3 py-1 rounded-full">
                                    <i class="fas fa-brain mr-1"></i>GPT-4o-mini
                                </span>
                            </div>

                            <!-- Consultas sugeridas -->
                            <div class="mb-6">
                                <h4 class="text-sm font-semibold text-gray-700 mb-3">Consultas sugeridas:</h4>
                                <div class="flex flex-wrap gap-2">
                                    <button onclick="setChatMessage('Hoy')" class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs hover:bg-green-200 transition-colors">
                                        <i class="fas fa-calendar-day mr-1"></i>Hoy
                                    </button>
                                    <button onclick="setChatMessage('Ayer')" class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs hover:bg-blue-200 transition-colors">
                                        <i class="fas fa-calendar-minus mr-1"></i>Ayer
                                    </button>
                                    <button onclick="setChatMessage('El martes')" class="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-xs hover:bg-purple-200 transition-colors">
                                        <i class="fas fa-calendar-week mr-1"></i>El martes
                                    </button>
                                    <button onclick="setChatMessage('Cliente VIP')" class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs hover:bg-indigo-200 transition-colors">
                                        <i class="fas fa-crown mr-1"></i>Cliente VIP
                                    </button>
                                    <button onclick="setChatMessage('Esta semana')" class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-xs hover:bg-yellow-200 transition-colors">
                                        <i class="fas fa-calendar-week mr-1"></i>Esta semana
                                    </button>
                                    <button onclick="setChatMessage('Mejor d√≠a')" class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-xs hover:bg-red-200 transition-colors">
                                        <i class="fas fa-chart-line mr-1"></i>Mejor d√≠a
                                    </button>
                                </div>
                            </div>

                            <!-- Chat Messages Area -->
                            <div id="chat-messages" class="bg-gray-50 rounded-xl p-4 flex-1 overflow-y-auto mb-4 space-y-4 min-h-[500px]">
                                <div class="text-center text-gray-500 text-sm">
                                    <i class="fas fa-comments text-2xl mb-2 block"></i>
                                    <p>¬°Hola! Soy tu analista de datos especializado en Adaptoheal.</p>
                                    <p class="mt-1">Preg√∫ntame sobre ventas, productos, clientes o cualquier m√©trica.</p>
                                    <p class="mt-2 text-xs">Ejemplo: "¬øCu√°les fueron las ventas de ayer?" o "Mu√©strame el mejor cliente"</p>
                                </div>
                            </div>

                            <!-- Chat Input -->
                            <div class="flex space-x-3">
                                <input 
                                    type="text" 
                                    id="chat-input" 
                                    placeholder="Preg√∫ntame sobre cualquier fecha... ej: ¬øCu√°nto vendimos hoy? ¬øQu√© tal ayer? ¬øEl martes?" 
                                    class="flex-1 px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none text-sm"
                                    onkeypress="handleChatKeyPress(event)"
                                    disabled
                                >
                                <button 
                                    id="chat-send" 
                                    onclick="sendChatMessage()" 
                                    class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-6 py-3 rounded-xl hover:from-purple-600 hover:to-indigo-700 transition-all duration-200 shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed"
                                    disabled
                                >
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- COLUMNA DERECHA: Top Products + Top Orders -->
                    <div class="space-y-6">
                        <!-- Top Products Card -->
                        <div class="glass-effect rounded-xl p-8 card-hover">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center space-x-3">
                                    <div class="p-2 rounded-lg bg-gradient-to-r from-yellow-400 to-orange-500">
                                        <i class="fas fa-crown text-lg text-white"></i>
                                    </div>
                                    <div>
                                        <h2 class="text-xl font-bold text-gray-800">Top 5 Productos</h2>
                                        <p id="products-period-label" class="text-sm text-gray-500">Por unidades vendidas</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-yellow-600 font-medium">POPULARES</p>
                                    <p class="text-xs text-gray-500">Por ventas totales</p>
                                </div>
                            </div>
                            <div id="top-products" class="space-y-3">
                                <!-- Productos se cargan din√°micamente -->
                            </div>
                        </div>

                        <!-- Top Orders Card -->
                        <div class="glass-effect rounded-xl p-8 card-hover">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center space-x-3">
                                    <div class="p-2 rounded-lg bg-gradient-to-r from-emerald-500 to-teal-600">
                                        <i class="fas fa-medal text-lg text-white"></i>
                                    </div>
                                    <div>
                                        <h2 class="text-xl font-bold text-gray-800">Top 5 √ìrdenes</h2>
                                        <p id="orders-period-label" class="text-sm text-gray-500">Mayor valor</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-emerald-600 font-medium">VIP</p>
                                    <p class="text-xs text-gray-500">Clientes premium</p>
                                </div>
                            </div>
                            <div id="top-orders" class="space-y-3">
                                <!-- √ìrdenes se cargan din√°micamente -->
                            </div>
                        </div>
                    </div>
                </div>



            </div>

            <!-- Error State -->
            <div id="error" class="hidden bg-red-50 border border-red-200 rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle text-red-600 mr-3"></i>
                        <div>
                            <h3 id="error-title" class="text-red-800 font-medium">Error de Conexi√≥n</h3>
                            <p id="error-message" class="text-red-600 text-sm mt-1">Cargando detalles del error...</p>
                        </div>
                    </div>
                    <button onclick="retryConnection()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-sm">
                        <i class="fas fa-refresh mr-1"></i>Reintentar
                    </button>
                </div>
            </div>
        </div>

        <script>
        // Variables globales
        let dashboardData = null;
        let activePeriod = 'september-2025';
        let comparisonEnabled = true; // Simplificado: solo on/off
        let customDateRange = null;

        // Funci√≥n para formatear n√∫meros como moneda MXN
        const formatCurrency = (amount) => {
          return new Intl.NumberFormat('es-MX', {
            style: 'currency',
            currency: 'MXN',
            minimumFractionDigits: 2
          }).format(amount);
        };

        // Funci√≥n para formatear n√∫meros grandes
        const formatNumber = (num) => {
          return new Intl.NumberFormat('es-MX').format(num);
        };

        // Funci√≥n para manejar cambio de per√≠odo
        function changePeriod() {
          const selector = document.getElementById('period-selector');
          const selectedPeriod = selector.value;
          
          if (selectedPeriod === 'custom') {
            showCustomDatePanel();
          } else {
            hideCustomDatePanel();
            activePeriod = selectedPeriod;
            
            // Actualizar texto de comparaci√≥n
            if (comparisonEnabled) {
              updateComparisonPeriodText();
            }
            
            loadDashboard();
          }
        }
        
        // Funci√≥n para activar/desactivar comparaci√≥n
        function toggleComparison() {
          const checkbox = document.getElementById('enable-comparison');
          const infoPanel = document.getElementById('comparison-period-info');
          
          comparisonEnabled = checkbox.checked;
          
          if (comparisonEnabled) {
            infoPanel.classList.remove('hidden');
            updateComparisonPeriodText();
          } else {
            infoPanel.classList.add('hidden');
          }
          
          console.log('Comparaci√≥n:', comparisonEnabled ? 'activada' : 'desactivada');
          
          // Recargar dashboard
          loadDashboard();
        }
        
        // Funci√≥n para actualizar el texto del per√≠odo de comparaci√≥n
        function updateComparisonPeriodText() {
          const textElement = document.getElementById('comparison-period-text');
          if (!textElement) return;
          
          let comparisonText = '';
          
          // Determinar qu√© per√≠odo se est√° comparando basado en el per√≠odo principal
          switch (activePeriod) {
            case 'today':
              comparisonText = 'vs Ayer';
              break;
            case 'yesterday':
              comparisonText = 'vs Anteayer';
              break;
            case 'last-7-days':
              comparisonText = 'vs 7 d√≠as anteriores';
              break;
            case 'last-30-days':
              comparisonText = 'vs 30 d√≠as anteriores';
              break;
            case 'this-month':
              comparisonText = 'vs Mes anterior';
              break;
            case 'last-month':
              comparisonText = 'vs 2 meses atr√°s';
              break;
            case 'october-2025':
              comparisonText = 'vs Septiembre 2025';
              break;
            case 'august-2025':
              comparisonText = 'vs Julio 2025';
              break;
            case 'september-2025':
              comparisonText = 'vs Agosto 2025';
              break;

            case 'custom':
              comparisonText = 'vs Per√≠odo anterior equivalente';
              break;
            default:
              comparisonText = 'vs Per√≠odo anterior equivalente';
          }
          
          textElement.textContent = comparisonText;
        }

        // Mostrar panel de fechas personalizadas
        function showCustomDatePanel() {
          const panel = document.getElementById('custom-date-panel');
          panel.classList.remove('hidden');
          
          // Establecer fechas por defecto (agosto 2025)
          document.getElementById('start-date').value = '2025-08-01';
          document.getElementById('end-date').value = '2025-09-30';
        }

        // Ocultar panel de fechas personalizadas
        function hideCustomDatePanel() {
          const panel = document.getElementById('custom-date-panel');
          panel.classList.add('hidden');
          customDateRange = null;
        }

        // Aplicar fechas personalizadas
        function applyCustomDates() {
          const startDate = document.getElementById('start-date').value;
          const endDate = document.getElementById('end-date').value;
          
          if (!startDate || !endDate) {
            alert('Por favor selecciona ambas fechas');
            return;
          }
          
          if (new Date(startDate) > new Date(endDate)) {
            alert('La fecha de inicio debe ser anterior a la fecha final');
            return;
          }
          
          customDateRange = { start: startDate, end: endDate };
          activePeriod = 'custom';
          hideCustomDatePanel();
          
          // Actualizar texto de comparaci√≥n
          if (comparisonEnabled) {
            updateComparisonPeriodText();
          }
          
          loadDashboard();
        }

        // Cancelar fechas personalizadas
        function cancelCustomDates() {
          hideCustomDatePanel();
          
          // Resetear selector a valor anterior
          const selector = document.getElementById('period-selector');
          selector.value = activePeriod;
        }

        // Funci√≥n para actualizar filtros de estado de √≥rdenes
        function updateOrderStatusFilter() {
          // Recargar dashboard con nuevos filtros
          loadDashboard();
        }

        // Presets de filtros
        function applyWooCommercePreset() {
          // Activar solo completed, processing y delivered
          document.getElementById('status-completed').checked = true;
          document.getElementById('status-delivered').checked = true;
          document.getElementById('status-processing').checked = true;
          document.getElementById('status-on-hold').checked = false;
          document.getElementById('status-pending').checked = false;
          updateOrderStatusFilter();
        }

        function applyConservativePreset() {
          // Solo completed
          document.getElementById('status-completed').checked = true;
          document.getElementById('status-delivered').checked = false;
          document.getElementById('status-processing').checked = false;
          document.getElementById('status-on-hold').checked = false;
          document.getElementById('status-pending').checked = false;
          updateOrderStatusFilter();
        }

        function applyAllStatusPreset() {
          // Todos los estados
          document.getElementById('status-completed').checked = true;
          document.getElementById('status-delivered').checked = true;
          document.getElementById('status-processing').checked = true;
          document.getElementById('status-on-hold').checked = true;
          document.getElementById('status-pending').checked = true;
          updateOrderStatusFilter();
        }

        // Obtener estados activos
        function getActiveStatuses() {
          const statuses = [];
          if (document.getElementById('status-completed').checked) statuses.push('completed');
          if (document.getElementById('status-delivered').checked) statuses.push('delivered');
          if (document.getElementById('status-processing').checked) statuses.push('processing');
          if (document.getElementById('status-on-hold').checked) statuses.push('on-hold');
          if (document.getElementById('status-pending').checked) statuses.push('pending');
          return statuses;
        }

        // Funci√≥n para verificar si token est√° expirado
        function isTokenExpired(token) {
          if (!token) return true;
          try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            const currentTime = Math.floor(Date.now() / 1000);
            return payload.exp < currentTime;
          } catch (error) {
            return true;
          }
        }

        // Funci√≥n para verificar autenticaci√≥n antes de cargar dashboard
        function checkAuthBeforeLoad() {
          const token = localStorage.getItem('auth_token');
          
          // Si no hay token, redirigir inmediatamente
          if (!token) {
            console.log('No hay token, redirigiendo a login');
            localStorage.clear();
            window.location.href = '/login';
            return false;
          }
          
          // Verificar si el token est√° expirado
          if (isTokenExpired(token)) {
            console.log('Token expirado, redirigiendo a login');
            localStorage.clear();
            window.location.href = '/login';
            return false;
          }
          
          // Verificar formato v√°lido del token (debe tener 3 partes separadas por puntos)
          const tokenParts = token.split('.');
          if (tokenParts.length !== 3) {
            console.log('Token con formato inv√°lido, redirigiendo a login');
            localStorage.clear();
            window.location.href = '/login';
            return false;
          }
          
          return true;
        }

        // Funci√≥n para obtener fechas de per√≠odos hist√≥ricos
        function getHistoricalPeriodDates(period) {
          const dates = {
            'historical-2025-h1': { start: '2025-01-01', end: '2025-06-30' },
            'historical-2024-full': { start: '2024-01-01', end: '2024-12-31' },
            'historical-2023-full': { start: '2023-01-01', end: '2023-12-31' },
            'historical-2022-full': { start: '2022-01-01', end: '2022-12-31' },
            'historical-2021-full': { start: '2021-01-01', end: '2021-12-31' },
            'historical-2020-full': { start: '2020-01-01', end: '2020-12-31' },
            'historical-all-time': { start: '2020-01-01', end: '2025-07-31' }
          };
          
          return dates[period] || { start: '2025-01-01', end: '2025-07-31' };
        }

        // Cargar dashboard
        async function loadDashboard() {
          // Verificar autenticaci√≥n antes de proceder
          if (!checkAuthBeforeLoad()) {
            return;
          }
          
          try {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('error').classList.add('hidden');

            // Construir par√°metros de query
            let queryParams = new URLSearchParams();
            
            // Per√≠odo
            if (customDateRange) {
              queryParams.set('start_date', customDateRange.start);
              queryParams.set('end_date', customDateRange.end);
            } else {
              queryParams.set('period', activePeriod);
            }
            
            // Filtros de estado
            const activeStatuses = getActiveStatuses();
            queryParams.set('status_filters', activeStatuses.join(','));
            
            // Per√≠odo de comparaci√≥n (simplificado)
            if (comparisonEnabled) {
              queryParams.set('enableComparison', 'true');
              queryParams.set('comparison_period', 'auto'); // Siempre autom√°tico
            }

            console.log('Haciendo request a dashboard con params:', queryParams.toString());
            
            // Detectar si es un per√≠odo hist√≥rico
            const isHistoricalPeriod = activePeriod && activePeriod.startsWith('historical-');
            let apiEndpoint = '/api/dashboard';
            
            if (isHistoricalPeriod) {
              // Configurar fechas para per√≠odos hist√≥ricos
              const historicalDates = getHistoricalPeriodDates(activePeriod);
              queryParams.set('start_date', historicalDates.start);
              queryParams.set('end_date', historicalDates.end);
              queryParams.set('source', 'historical');
              apiEndpoint = '/api/historical-data';
              
              console.log('üìä Usando datos hist√≥ricos:', historicalDates);
            }
            
            // Usar axios que ya tiene configurado el Authorization header
            const response = await axios.get(`${apiEndpoint}?${queryParams.toString()}`);
            const result = response.data;

            console.log('Respuesta del API:', result);
            console.log('Success value:', result.success, typeof result.success);

            // Manejar diferentes estructuras de respuesta
            let processedData, debugInfo, statusBreakdown;
            
            if (isHistoricalPeriod) {
              // Respuesta de /api/historical-data: { statistics, orders, sources }
              if (!result || !result.statistics) {
                console.error('Historical API response failed:', result);
                throw new Error(result?.error || result?.message || 'Error de API datos hist√≥ricos - respuesta inv√°lida');
              }
              
              // Adaptar estructura de datos hist√≥ricos a formato dashboard
              processedData = {
                // Estad√≠sticas principales
                totalRevenue: result.statistics.totalRevenue || 0,
                totalOrders: result.statistics.totalOrders || 0,
                averageOrderValue: result.statistics.averageOrderValue || 0,
                
                // √ìrdenes para tabla
                orders: result.orders || [],
                
                // Informaci√≥n de fuente de datos
                dataSource: {
                  name: 'Datos Hist√≥ricos',
                  period: activePeriod,
                  sources: result.sources || { historical: 0, woocommerce: 0, total: 0 }
                }
              };
              
              debugInfo = {
                periodInfo: {
                  displayName: 'Hist√≥rico - ' + activePeriod.replace('historical-', '').toUpperCase(),
                  dateRange: queryParams.get('start_date') + ' a ' + queryParams.get('end_date'),
                  source: 'historical',
                  orderCount: result.statistics.totalOrders || 0
                },
                statusBreakdownAll: {
                  completed: result.orders?.filter(o => o.status === 'completed')?.length || 0,
                  processing: result.orders?.filter(o => o.status === 'processing')?.length || 0,
                  pending: result.orders?.filter(o => o.status === 'pending')?.length || 0,
                  'on-hold': result.orders?.filter(o => o.status === 'on-hold')?.length || 0,
                  delivered: result.orders?.filter(o => o.status === 'delivered')?.length || 0
                }
              };
              
              console.log('üìä Procesando datos hist√≥ricos:', processedData);
              
            } else {
              // Respuesta normal de /api/dashboard: { success, data, debug }
              if (!result || result.success !== true) {
                console.error('API response failed:', result);
                throw new Error(result?.error || result?.message || 'Error de API - respuesta inv√°lida');
              }
              
              processedData = result.data;
              debugInfo = result.debug;
            }

            dashboardData = processedData;
            updateDashboardUI();
            updatePeriodDisplay(debugInfo?.periodInfo);
            updateStatusCounters(debugInfo?.statusBreakdownAll || {});
            updateComparisonInfo(processedData?.comparative?.periodInfo);
            
            // Habilitar chat despu√©s de cargar datos
            enableChat();

          } catch (error) {
            console.error('Error loading dashboard:', error);
            console.error('Error stack:', error.stack);
            console.error('Error response:', error.response);
            
            // Determinar tipo de error y mostrar mensaje apropiado
            let errorTitle = 'Error Inesperado';
            let errorMessage = 'Ocurri√≥ un error inesperado: ' + error.message;
            
            // Verificar si es error de autenticaci√≥n (token expirado/inv√°lido)
            const isTokenError = (
              (error.response && error.response.status === 401) ||
              (error.message && error.message.includes('Token')) ||
              (error.response && error.response.data && error.response.data.error && 
               (error.response.data.error.includes('Token') || 
                error.response.data.error.includes('token') ||
                error.response.data.error.includes('inv√°lido') ||
                error.response.data.error.includes('expirado')))
            );
            
            if (isTokenError) {
              errorTitle = 'Sesi√≥n Expirada';
              errorMessage = 'Tu sesi√≥n ha expirado. Redirigiendo al login...';
              // Limpiar completamente el localStorage
              localStorage.removeItem('auth_token');
              localStorage.removeItem('user_info');
              localStorage.clear(); // Limpieza adicional por seguridad
              console.log('Token inv√°lido detectado - Limpiando localStorage y redirigiendo');
              setTimeout(() => {
                window.location.href = '/login';
              }, 2000);
            } else if (error.response && error.response.status >= 500) {
              errorTitle = 'Error del Servidor';
              errorMessage = 'Error interno del servidor. Por favor, intenta m√°s tarde.';
            } else if (error.message.includes('Network Error')) {
              errorTitle = 'Error de Conectividad';
              errorMessage = 'No se pudo conectar con el servidor. Verifica tu conexi√≥n a internet.';
            } else if (error.response && error.response.data && error.response.data.error) {
              // Si el error menciona token o autenticaci√≥n
              if (error.response.data.error.includes('Token') || error.response.data.error.includes('token')) {
                errorTitle = 'Problema de Autenticaci√≥n';
                errorMessage = 'Error de autenticaci√≥n. Redirigiendo al login...';
                localStorage.removeItem('auth_token');
                localStorage.removeItem('user_info');
                setTimeout(() => {
                  window.location.href = '/login';
                }, 2000);
              } else {
                errorTitle = 'Error de API';
                errorMessage = error.response.data.error;
              }
            }
            
            // Mostrar error con detalles espec√≠ficos
            document.getElementById('error-title').textContent = errorTitle;
            document.getElementById('error-message').textContent = errorMessage;
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
          }
        }

        // Funci√≥n auxiliar para formatear cambios porcentuales
        function formatPercentageChange(change, showIcon = true) {
          if (change === null || change === undefined || isNaN(change)) {
            return showIcon ? '<span class="text-gray-400 text-xs"><i class="fas fa-minus"></i></span>' : '--';
          }
          
          const isPositive = change >= 0;
          const bgClass = isPositive ? 'bg-green-100 text-green-700 border-green-200' : 'bg-red-100 text-red-700 border-red-200';
          const iconClass = isPositive ? 'fas fa-arrow-up' : 'fas fa-arrow-down';
          const prefix = isPositive ? '+' : '';
          
          if (showIcon) {
            return `<span class="${bgClass} text-xs font-semibold px-2 py-1 rounded-full border inline-flex items-center space-x-1"><i class="${iconClass} text-xs"></i><span>${prefix}${Math.abs(change).toFixed(1)}%</span></span>`;
          } else {
            return `<span class="${bgClass} px-2 py-1 rounded text-xs font-medium">${prefix}${change.toFixed(1)}%</span>`;
          }
        }

        // Funci√≥n para cargar datos de Google Analytics 4
        async function loadAnalytics() {
          try {
            console.log('üîç Cargando datos de Google Analytics 4...');
            
            // Verificar que los elementos existan
            const loadingElement = document.getElementById('analytics-loading');
            const contentElement = document.getElementById('analytics-content');
            const errorElement = document.getElementById('analytics-error');
            
            if (!loadingElement || !contentElement || !errorElement) {
              console.error('‚ùå Elementos GA4 no encontrados en el DOM');
              console.error('Loading element:', loadingElement);
              console.error('Content element:', contentElement);
              console.error('Error element:', errorElement);
              return;
            }
            
            // Mostrar loading state
            loadingElement.classList.remove('hidden');
            contentElement.classList.add('hidden');
            errorElement.classList.add('hidden');
            
            // Hacer request a GA4 API (7 d√≠as por defecto)
            const response = await axios.get('/api/analytics?days=7');
            const result = response.data;
            
            if (!result.success) {
              throw new Error(result.error || 'Error cargando datos GA4');
            }
            
            const ga4Data = result.data;
            console.log('üìä Datos GA4 recibidos:', ga4Data);
            
            // Actualizar usuarios
            document.getElementById('ga4-total-users').textContent = ga4Data.users.totalUsers.toLocaleString();
            document.getElementById('ga4-new-users').textContent = ga4Data.users.newUsers.toLocaleString();
            document.getElementById('ga4-returning-users').textContent = ga4Data.users.returningUsers.toLocaleString();
            
            // Calcular porcentajes
            const totalUsers = ga4Data.users.totalUsers;
            const newPercentage = totalUsers > 0 ? ((ga4Data.users.newUsers / totalUsers) * 100).toFixed(1) : 0;
            const returningPercentage = totalUsers > 0 ? ((ga4Data.users.returningUsers / totalUsers) * 100).toFixed(1) : 0;
            
            document.getElementById('ga4-new-users-percentage').textContent = `${newPercentage}% del total`;
            document.getElementById('ga4-returning-percentage').textContent = `${returningPercentage}% del total`;
            
            // Mostrar p√°ginas m√°s visitadas
            const topPagesContainer = document.getElementById('ga4-top-pages');
            topPagesContainer.innerHTML = '';
            
            ga4Data.pages.slice(0, 5).forEach((page, index) => {
              const pageElement = document.createElement('div');
              pageElement.className = 'flex items-center justify-between p-2 bg-white rounded border';
              pageElement.innerHTML = `
                <div class="flex items-center space-x-2">
                  <span class="w-6 h-6 bg-orange-100 text-orange-600 text-xs font-bold rounded-full flex items-center justify-center">${index + 1}</span>
                  <div>
                    <p class="text-sm font-medium text-gray-800 truncate" style="max-width: 200px;" title="${page.title}">${page.title}</p>
                    <p class="text-xs text-gray-500 truncate" style="max-width: 200px;" title="${page.path}">${page.path}</p>
                  </div>
                </div>
                <span class="text-sm font-semibold text-gray-600">${page.pageViews.toLocaleString()}</span>
              `;
              topPagesContainer.appendChild(pageElement);
            });
            
            // Mostrar pa√≠ses
            const countriesContainer = document.getElementById('ga4-countries');
            countriesContainer.innerHTML = '';
            
            ga4Data.demographics.countries.slice(0, 5).forEach((country, index) => {
              const countryElement = document.createElement('div');
              countryElement.className = 'flex items-center justify-between p-2 bg-white rounded border';
              countryElement.innerHTML = `
                <div class="flex items-center space-x-2">
                  <span class="w-6 h-6 bg-blue-100 text-blue-600 text-xs font-bold rounded-full flex items-center justify-center">${index + 1}</span>
                  <span class="text-sm font-medium text-gray-800">${country.name}</span>
                </div>
                <span class="text-sm font-semibold text-gray-600">${country.users.toLocaleString()}</span>
              `;
              countriesContainer.appendChild(countryElement);
            });
            
            // Mostrar fuentes de tr√°fico
            const trafficContainer = document.getElementById('ga4-traffic-sources');
            trafficContainer.innerHTML = '';
            
            ga4Data.traffic.slice(0, 4).forEach(source => {
              const sourceElement = document.createElement('div');
              sourceElement.className = 'bg-white rounded-lg p-3 border text-center';
              sourceElement.innerHTML = `
                <p class="text-xs font-medium text-gray-600 uppercase">${source.channel}</p>
                <p class="text-lg font-bold text-gray-900">${source.sessions.toLocaleString()}</p>
                <p class="text-xs text-gray-500">${source.users.toLocaleString()} usuarios</p>
              `;
              trafficContainer.appendChild(sourceElement);
            });
            
            // Mostrar contenido y ocultar loading
            document.getElementById('analytics-loading').classList.add('hidden');
            document.getElementById('analytics-content').classList.remove('hidden');
            
            console.log('‚úÖ Datos GA4 cargados correctamente');
            
          } catch (error) {
            console.error('‚ùå Error cargando Google Analytics:', error.message);
            
            // Mostrar error state
            document.getElementById('analytics-loading').classList.add('hidden');
            document.getElementById('analytics-content').classList.add('hidden');
            document.getElementById('analytics-error').classList.remove('hidden');
            document.getElementById('analytics-error-message').textContent = error.message;
          }
        }

        // Funci√≥n para cargar datos de Google Ads
        async function loadGoogleAds() {
          try {
            console.log('üéØ Cargando datos de Google Ads...');
            
            // Verificar que los elementos existan
            const loadingElement = document.getElementById('ads-loading');
            const contentElement = document.getElementById('ads-content');
            const errorElement = document.getElementById('ads-error');
            
            if (!loadingElement || !contentElement || !errorElement) {
              console.error('‚ùå Elementos Google Ads no encontrados en el DOM');
              return;
            }
            
            // Mostrar loading state
            loadingElement.classList.remove('hidden');
            contentElement.classList.add('hidden');
            errorElement.classList.add('hidden');
            
            // Hacer request a Google Ads API (7 d√≠as por defecto)
            const response = await axios.get('/api/ads?days=7');
            const result = response.data;
            
            if (!result.success) {
              throw new Error(result.error || 'Error cargando datos Google Ads');
            }
            
            const adsData = result.data;
            console.log('üéØ Datos Google Ads recibidos:', adsData);
            
            // Actualizar m√©tricas principales
            document.getElementById('ads-total-spend').textContent = '$' + parseFloat(adsData.summary.totalSpend || 0).toLocaleString('es-MX', {minimumFractionDigits: 2});
            document.getElementById('ads-total-clicks').textContent = (adsData.summary.totalClicks || 0).toLocaleString();
            document.getElementById('ads-total-impressions').textContent = (adsData.summary.totalImpressions || 0).toLocaleString();
            document.getElementById('ads-total-conversions').textContent = (adsData.summary.totalConversions || 0).toLocaleString();
            
            // Actualizar m√©tricas adicionales
            document.getElementById('ads-average-ctr').textContent = (adsData.summary.averageCTR || 0) + '%';
            document.getElementById('ads-cost-per-click').textContent = '$' + parseFloat(adsData.summary.costPerClick || 0).toLocaleString('es-MX', {minimumFractionDigits: 2});
            document.getElementById('ads-cost-per-conversion').textContent = '$' + parseFloat(adsData.summary.costPerConversion || 0).toLocaleString('es-MX', {minimumFractionDigits: 2});
            
            // Mostrar top campa√±as
            const campaignsContainer = document.getElementById('ads-top-campaigns');
            campaignsContainer.innerHTML = '';
            
            if (adsData.campaigns && adsData.campaigns.campaigns && adsData.campaigns.campaigns.length > 0) {
              adsData.campaigns.campaigns.slice(0, 5).forEach((campaign, index) => {
                const campaignElement = document.createElement('div');
                campaignElement.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                campaignElement.innerHTML = `
                  <div class="flex-1">
                    <p class="font-medium text-gray-900 text-sm truncate">${campaign.name}</p>
                    <div class="flex items-center space-x-3 mt-1">
                      <span class="text-xs text-gray-500">${campaign.clicks.toLocaleString()} clics</span>
                      <span class="text-xs text-gray-500">${campaign.impressions.toLocaleString()} impres.</span>
                    </div>
                  </div>
                  <div class="text-right">
                    <p class="font-bold text-gray-900">$${parseFloat(campaign.cost).toLocaleString('es-MX', {minimumFractionDigits: 2})}</p>
                    <p class="text-xs text-gray-500">${campaign.ctr}% CTR</p>
                  </div>
                `;
                campaignsContainer.appendChild(campaignElement);
              });
            } else {
              campaignsContainer.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No hay datos de campa√±as disponibles</p>';
            }
            
            // Mostrar top keywords
            const keywordsContainer = document.getElementById('ads-top-keywords');
            keywordsContainer.innerHTML = '';
            
            if (adsData.keywords && adsData.keywords.keywords && adsData.keywords.keywords.length > 0) {
              adsData.keywords.keywords.slice(0, 5).forEach((keyword, index) => {
                const keywordElement = document.createElement('div');
                keywordElement.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                keywordElement.innerHTML = `
                  <div class="flex-1">
                    <p class="font-medium text-gray-900 text-sm truncate">${keyword.keyword}</p>
                    <div class="flex items-center space-x-2 mt-1">
                      <span class="text-xs font-medium text-blue-600 bg-blue-100 px-2 py-0.5 rounded">${keyword.matchType}</span>
                      <span class="text-xs text-gray-500">${keyword.clicks} clics</span>
                    </div>
                  </div>
                  <div class="text-right">
                    <p class="font-bold text-gray-900">$${parseFloat(keyword.cost).toLocaleString('es-MX', {minimumFractionDigits: 2})}</p>
                    <p class="text-xs text-gray-500">${keyword.conversions} conv.</p>
                  </div>
                `;
                keywordsContainer.appendChild(keywordElement);
              });
            } else {
              keywordsContainer.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No hay datos de keywords disponibles</p>';
            }
            
            // Mostrar contenido y ocultar loading
            document.getElementById('ads-loading').classList.add('hidden');
            document.getElementById('ads-content').classList.remove('hidden');
            
            console.log('‚úÖ Datos Google Ads cargados correctamente');
            
          } catch (error) {
            console.error('‚ùå Error cargando Google Ads:', error.message);
            
            // Mostrar error state
            document.getElementById('ads-loading').classList.add('hidden');
            document.getElementById('ads-content').classList.add('hidden');
            document.getElementById('ads-error').classList.remove('hidden');
            document.getElementById('ads-error-message').textContent = error.message;
          }
        }

        // Funci√≥n para actualizar informaci√≥n de comparaci√≥n
        function updateComparisonInfo(periodInfo) {
          const comparisonInfoDiv = document.getElementById('comparison-period-info');
          const comparisonLabel = document.getElementById('comparison-period-text');
          
          if (!periodInfo || !comparisonLabel) {
            // Si no hay informaci√≥n de comparaci√≥n o elemento no existe, no hacer nada
            if (comparisonInfoDiv) {
              comparisonInfoDiv.classList.add('hidden');
            }
            return;
          }
          
          let labelText = '';
          const comparisonPeriod = periodInfo.comparisonPeriod || 'auto';
          
          // Crear labels amigables para cada tipo de comparaci√≥n
          switch (comparisonPeriod) {
            case 'auto':
              labelText = 'vs per√≠odo anterior equivalente';
              break;
            case 'october-2025':
              labelText = 'vs Octubre 2025';
              break;
            case 'august-2025':
              labelText = 'vs Agosto 2025';
              break;
            case 'september-2025':
              labelText = 'vs Septiembre 2025';
              break;
            case 'july-2025':
              labelText = 'vs Julio 2025';
              break;
            case 'june-2025':
              labelText = 'vs Junio 2025';
              break;
            case 'last-30-days':
              labelText = 'vs √öltimos 30 d√≠as';
              break;
            case 'last-60-days':
              labelText = 'vs √öltimos 60 d√≠as';
              break;
            case 'previous-month':
              labelText = 'vs Mes anterior';
              break;
            case 'previous-quarter':
              labelText = 'vs Trimestre anterior';
              break;
            case 'same-month-last-year':
              labelText = 'vs Mismo mes a√±o anterior';
              break;
            default:
              labelText = 'vs per√≠odo personalizado';
          }
          
          comparisonLabel.textContent = labelText;
          if (comparisonInfoDiv) {
            comparisonInfoDiv.classList.remove('hidden');
          }
        }
        
        // Actualizar UI del dashboard
        function updateDashboardUI() {
          if (!dashboardData) return;

          // Detectar si son datos hist√≥ricos (estructura diferente)
          const isHistoricalData = dashboardData.dataSource && dashboardData.dataSource.name === 'Datos Hist√≥ricos';
          
          if (isHistoricalData) {
            // KPIs principales para datos hist√≥ricos
            document.getElementById('total-sales').textContent = formatCurrency(dashboardData.totalRevenue || 0);
            document.getElementById('avg-ticket').textContent = formatCurrency(dashboardData.averageOrderValue || 0);
            document.getElementById('orders-count').textContent = formatNumber(dashboardData.totalOrders || 0);
            
            // Mostrar indicador de fuente de datos
            updateDataSourceIndicator(dashboardData.dataSource);
            
            // Para datos hist√≥ricos, mostrar √≥rdenes b√°sicas y ocultar otras secciones
            updateHistoricalOrdersList();
            hideUnavailableSections();
            
          } else {
            // KPIs principales para datos WooCommerce (estructura original)
            document.getElementById('total-sales').textContent = formatCurrency(dashboardData.totalSales30Days);
            document.getElementById('avg-ticket').textContent = formatCurrency(dashboardData.avgTicket30Days);
            document.getElementById('orders-count').textContent = formatNumber(dashboardData.ordersCount30Days);
            
            // Mostrar todas las secciones para WooCommerce
            showAllSections();
          }
            
            // Indicadores comparativos de KPIs principales
            const comparative = dashboardData.comparative;
            if (comparative) {
              document.getElementById('total-sales-change').innerHTML = formatPercentageChange(comparative.totalSales.change);
              document.getElementById('avg-ticket-change').innerHTML = formatPercentageChange(comparative.avgTicket.change);
              document.getElementById('orders-count-change').innerHTML = formatPercentageChange(comparative.ordersCount.change);
            } else {
              document.getElementById('total-sales-change').innerHTML = '';
              document.getElementById('avg-ticket-change').innerHTML = '';
              document.getElementById('orders-count-change').innerHTML = '';
            }

            // M√©todos de pago
            const paymentMethods = dashboardData.paymentMethods;
          document.getElementById('stripe-sales').textContent = formatCurrency(paymentMethods.stripe.sales);
          document.getElementById('stripe-percentage').textContent = paymentMethods.stripe.percentage + '%';
          document.getElementById('stripe-orders').textContent = paymentMethods.stripe.orders + ' √≥rdenes';

          document.getElementById('paypal-sales').textContent = formatCurrency(paymentMethods.paypal.sales);
          document.getElementById('paypal-percentage').textContent = paymentMethods.paypal.percentage + '%';
          document.getElementById('paypal-orders').textContent = paymentMethods.paypal.orders + ' √≥rdenes';

          document.getElementById('transfer-sales').textContent = formatCurrency(paymentMethods.transfer.sales);
          document.getElementById('transfer-percentage').textContent = paymentMethods.transfer.percentage + '%';
          document.getElementById('transfer-orders').textContent = paymentMethods.transfer.orders + ' √≥rdenes';
          
            // Indicadores comparativos para m√©todos de pago
            if (comparative && comparative.paymentMethods) {
            document.getElementById('stripe-sales-change').innerHTML = formatPercentageChange(comparative.paymentMethods.stripe.salesChange);
            document.getElementById('paypal-sales-change').innerHTML = formatPercentageChange(comparative.paymentMethods.paypal.salesChange);
            document.getElementById('transfer-sales-change').innerHTML = formatPercentageChange(comparative.paymentMethods.transfer.salesChange);
          } else {
            document.getElementById('stripe-sales-change').innerHTML = '';
            document.getElementById('paypal-sales-change').innerHTML = '';
            document.getElementById('transfer-sales-change').innerHTML = '';
          }

            // Estados de √≥rdenes
            const orderStates = dashboardData.orderStates;
          document.getElementById('completed-sales').textContent = formatCurrency(orderStates.completed.sales);
          document.getElementById('completed-percentage').textContent = orderStates.completed.percentage + '%';
          document.getElementById('completed-orders').textContent = orderStates.completed.orders + ' √≥rdenes';

          document.getElementById('delivered-sales').textContent = formatCurrency(orderStates.delivered.sales);
          document.getElementById('delivered-percentage').textContent = orderStates.delivered.percentage + '%';
          document.getElementById('delivered-orders').textContent = orderStates.delivered.orders + ' √≥rdenes';

          document.getElementById('processing-sales').textContent = formatCurrency(orderStates.processing.sales);
          document.getElementById('processing-percentage').textContent = orderStates.processing.percentage + '%';
          document.getElementById('processing-orders').textContent = orderStates.processing.orders + ' √≥rdenes';
          
            // Indicadores comparativos para estados de √≥rdenes
            if (comparative && comparative.orderStates) {
            document.getElementById('completed-sales-change').innerHTML = formatPercentageChange(comparative.orderStates.completed.salesChange);
            document.getElementById('delivered-sales-change').innerHTML = formatPercentageChange(comparative.orderStates.delivered.salesChange);
            document.getElementById('processing-sales-change').innerHTML = formatPercentageChange(comparative.orderStates.processing.salesChange);
          } else {
            document.getElementById('completed-sales-change').innerHTML = '';
            document.getElementById('delivered-sales-change').innerHTML = '';
            document.getElementById('processing-sales-change').innerHTML = '';
          }

            // Tipos de cliente (Distribuidor vs Cliente)
            const customerTypes = dashboardData.customerTypes;
          
            // Distribuidores
          document.getElementById('distributors-sales').textContent = formatCurrency(customerTypes.distributors.sales);
          document.getElementById('distributors-percentage').textContent = customerTypes.distributors.percentage + '%';
          document.getElementById('distributors-orders').textContent = customerTypes.distributors.orders + ' √≥rdenes';
          document.getElementById('distributors-customers').textContent = customerTypes.distributors.customers + ' clientes √∫nicos';
          document.getElementById('distributors-avg-ticket').textContent = 'Ticket prom: ' + formatCurrency(customerTypes.distributors.avgTicket);
          document.getElementById('distributors-avg-customer').textContent = 'Por distribuidor: ' + formatCurrency(customerTypes.distributors.avgPerCustomer);

            // Clientes regulares
          document.getElementById('customers-sales').textContent = formatCurrency(customerTypes.customers.sales);
          document.getElementById('customers-percentage').textContent = customerTypes.customers.percentage + '%';
          document.getElementById('customers-orders').textContent = customerTypes.customers.orders + ' √≥rdenes';
          document.getElementById('customers-customers').textContent = customerTypes.customers.customers + ' clientes √∫nicos';
          document.getElementById('customers-avg-ticket').textContent = 'Ticket prom: ' + formatCurrency(customerTypes.customers.avgTicket);
          document.getElementById('customers-avg-customer').textContent = 'Por cliente: ' + formatCurrency(customerTypes.customers.avgPerCustomer);
          
            // Indicadores comparativos para tipos de cliente
            if (comparative && comparative.customerTypes) {
            document.getElementById('distributors-sales-change').innerHTML = formatPercentageChange(comparative.customerTypes.distributors.salesChange);
            document.getElementById('customers-sales-change').innerHTML = formatPercentageChange(comparative.customerTypes.customers.salesChange);
          } else {
            document.getElementById('distributors-sales-change').innerHTML = '';
            document.getElementById('customers-sales-change').innerHTML = '';
          }

            // Top products
            const topProductsHTML = dashboardData.topProducts.map((product, index) => `
            <div class="flex items-center justify-between p-3 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg border border-yellow-100">
              <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-lg flex items-center justify-center text-white text-sm font-bold">
                  ${index + 1}
                </div>
                <div>
                  <p class="text-sm font-medium text-gray-800 truncate max-w-[200px]">${product.name}</p>
                  <p class="text-xs text-gray-500">${formatCurrency(product.avgPrice)} c/u</p>
                </div>
              </div>
              <div class="text-right">
                <p class="text-sm font-bold text-yellow-700">${product.quantity} unidades</p>
                <p class="text-xs text-gray-500">${formatCurrency(product.totalSales)} ‚Ä¢ ${product.percentage}%</p>
                <p class="text-xs text-gray-500">ID: ${product.id}</p>
              </div>
            </div>
            `).join('');
            document.getElementById('top-products').innerHTML = topProductsHTML;

            // Top orders
          const topOrdersHTML = dashboardData.topOrders.map((order, index) => `
            <div class="flex items-center justify-between p-3 bg-gradient-to-r from-emerald-50 to-teal-50 rounded-lg border border-emerald-100">
              <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-gradient-to-r from-emerald-500 to-teal-600 rounded-lg flex items-center justify-center text-white text-sm font-bold">
                  ${index + 1}
                </div>
                <div>
                  <p class="text-sm font-medium text-gray-800">${order.customer}</p>
                  <p class="text-xs text-gray-500">Orden #${order.id}</p>
                </div>
              </div>
              <div class="text-right">
                <p class="text-sm font-bold text-emerald-700">${formatCurrency(order.total)}</p>
                <p class="text-xs text-gray-500">${new Date(order.date).toLocaleDateString('es-MX')}</p>
              </div>
            </div>
            `).join('');
            document.getElementById('top-orders').innerHTML = topOrdersHTML;
            
            // Actualizar labels de per√≠odo din√°micamente
            updateProductsAndOrdersLabels();
            
            // Actualizar secci√≥n unificada de cupones
            updateUnifiedCouponsSection();
            
            // NUEVO: Actualizar secciones de costos de env√≠o e insights
            updateShippingCostsSection();
            updateShippingInsightsSection();
          }

          document.getElementById('loading').classList.add('hidden');
          document.getElementById('dashboard').classList.remove('hidden');
        }

        // Mostrar indicador de fuente de datos para hist√≥ricos - TEMPORAL COMENTADO
        function updateDataSourceIndicator(dataSource) {
          console.log('üìä Datos hist√≥ricos detectados:', dataSource.name);
          // Funci√≥n temporalmente simplificada para evitar errores JS
        }

        // Ocultar secciones no disponibles para datos hist√≥ricos - TEMPORAL COMENTADO  
        function hideUnavailableSections() {
          console.log('üìä Funci√≥n hideUnavailableSections llamada');
          return; // Temporalmente deshabilitada
          /*
          const sectionsToHide = [
            'payment-methods-section',
            'order-states-section', 
            'customer-types-section',
            'top-products-section',
            'coupon-analysis-section',
            'shipping-costs-section'
          ];
          
          sectionsToHide.forEach(sectionId => {
            const section = document.getElementById(sectionId);
            if (section) {
              section.style.display = 'none';
            }
          });
          
          // Mostrar mensaje informativo
          showHistoricalLimitationsMessage();
        }

        // Mostrar todas las secciones para WooCommerce
        function showAllSections() {
          const sectionsToShow = [
            'payment-methods-section',
            'order-states-section',
            'customer-types-section', 
            'top-products-section',
            'coupon-analysis-section',
            'shipping-costs-section'
          ];
          
          sectionsToShow.forEach(sectionId => {
            const section = document.getElementById(sectionId);
            if (section) {
              section.style.display = '';
            }
          });
          
          // Remover indicador de hist√≥ricos si existe
          const indicator = document.getElementById('data-source-indicator');
          if (indicator) indicator.remove();
          
          // Remover mensaje de limitaciones
          const limitationsMsg = document.getElementById('historical-limitations-message');
          if (limitationsMsg) limitationsMsg.remove();
        */ }

        // Mostrar mensaje sobre limitaciones de datos hist√≥ricos - TEMPORAL COMENTADO
        function showHistoricalLimitationsMessage() {
          console.log('üìä Funci√≥n showHistoricalLimitationsMessage llamada');
          return; // Temporalmente deshabilitada
          /*
          if (document.getElementById('historical-limitations-message')) return;
          
          const dashboardContent = document.getElementById('dashboard');
          const message = document.createElement('div');
          message.id = 'historical-limitations-message';
          message.className = 'mb-6';
          message.innerHTML = `
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <div class="flex items-start space-x-3">
                <i class="fas fa-info-circle text-blue-600 mt-1"></i>
                <div>
                  <h4 class="text-blue-800 font-medium mb-2">Datos Hist√≥ricos Excel</h4>
                  <p class="text-blue-700 text-sm mb-2">
                    Est√°s viendo datos hist√≥ricos importados desde Excel. Las siguientes secciones est√°n disponibles:
                  </p>
                  <ul class="text-blue-700 text-sm space-y-1">
                    <li>‚úÖ Estad√≠sticas principales (ingresos, √≥rdenes, ticket promedio)</li>
                    <li>‚úÖ Lista de √≥rdenes con detalles b√°sicos</li>
                  </ul>
                  <p class="text-blue-700 text-sm mt-2">
                    <strong>Nota:</strong> Los an√°lisis detallados de m√©todos de pago, productos y cupones est√°n disponibles solo para per√≠odos posteriores a agosto 2025 con datos de WooCommerce.
                  </p>
                </div>
              </div>
            </div>
          `;
          
          // Insertar despu√©s del indicador de fuente de datos
          const indicator = document.getElementById('data-source-indicator');
          if (indicator) {
            indicator.after(message);
          } else {
            dashboardContent.prepend(message);
          }
        */ }

        // Actualizar lista de √≥rdenes hist√≥ricas - TEMPORAL COMENTADO
        function updateHistoricalOrdersList() {
          console.log('üìä Funci√≥n updateHistoricalOrdersList llamada');
          return; // Temporalmente deshabilitada
          /*
          if (!dashboardData.orders) return;
          
          // Tomar las primeras 10 √≥rdenes para mostrar
          const ordersToShow = dashboardData.orders.slice(0, 10);
          
          const ordersHTML = ordersToShow.map((order, index) => {
            const statusClass = order.status === 'completed' ? 'bg-green-100 text-green-800' : 
              order.status === 'processing' ? 'bg-blue-100 text-blue-800' :
              order.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
              'bg-gray-100 text-gray-800';
            
            return `
            <div class="flex items-center justify-between p-3 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg border border-purple-100">
              <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-lg flex items-center justify-center text-white text-sm font-bold">
                  ` + (index + 1) + `
                </div>
                <div>
                  <p class="text-sm font-medium text-gray-800">` + (order.customer_email || 'Cliente') + `</p>
                  <p class="text-xs text-gray-500">Orden #` + order.id + `</p>
                  <p class="text-xs text-purple-600 font-medium">üìä Hist√≥rico</p>
                </div>
              </div>
              <div class="text-right">
                <p class="text-sm font-bold text-purple-700">` + formatCurrency(order.total) + `</p>
                <p class="text-xs text-gray-500">` + new Date(order.date_created).toLocaleDateString('es-MX') + `</p>
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ` + statusClass + `">` + order.status + `</span>
              </div>
            </div>
          `;
          }).join('');
          
          // Actualizar la secci√≥n de top orders con datos hist√≥ricos
          const topOrdersContainer = document.getElementById('top-orders');
          if (topOrdersContainer) {
            topOrdersContainer.innerHTML = ordersHTML;
          }
          
          // Actualizar el t√≠tulo de la secci√≥n para reflejar hist√≥ricos
          const topOrdersTitle = document.querySelector('#top-products-section h3');
          if (topOrdersTitle && topOrdersTitle.textContent.includes('√ìrdenes')) {
            topOrdersTitle.innerHTML = `
              <i class="fas fa-shopping-bag mr-2 text-purple-600"></i>
              √ìrdenes Hist√≥ricas - √öltimas 10
            `;
          }
        */ }

        // Actualizar display del per√≠odo activo
        function updatePeriodDisplay(periodInfo) {
          if (!periodInfo) return;
          
          const display = document.getElementById('active-period-display');
          
          // Si es un per√≠odo hist√≥rico, mostrar informaci√≥n especial
          if (periodInfo.source === 'historical') {
            display.innerHTML = 
              '<div class="flex items-center space-x-2">' +
                '<span class="bg-purple-100 text-purple-700 px-2 py-1 rounded-full text-xs font-semibold">' +
                  '<i class="fas fa-chart-bar mr-1"></i>HIST√ìRICO' +
                '</span>' +
                '<span class="font-medium">' + periodInfo.displayName + '</span>' +
                '<span class="text-gray-500 text-sm">(' + periodInfo.dateRange + ')</span>' +
              '</div>';
          } else {
            // Display normal para WooCommerce
            display.textContent = periodInfo.label || periodInfo.displayName || 'Per√≠odo Actual';
          }
        }

        // Actualizar labels de per√≠odo para productos y √≥rdenes
        function updateProductsAndOrdersLabels() {
          // Obtener el per√≠odo actual desde el selector
          const periodSelector = document.getElementById('period-selector');
          const selectedPeriod = periodSelector.value;
          
          let periodLabel = '';
          
          // Mapear los valores del selector a labels amigables
          switch(selectedPeriod) {
            case 'october-2025':
              periodLabel = 'Octubre 2025';
              break;

            case 'august-2025':
              periodLabel = 'Agosto 2025';
              break;
            case 'september-2025':
              periodLabel = 'Septiembre 2025';
              break;
            case 'previous-month':
              periodLabel = 'Mes Anterior';
              break;
            case 'current-month':
              periodLabel = 'Mes Actual';
              break;
            case 'last-7-days':
              periodLabel = '√öltimos 7 d√≠as';
              break;
            case 'last-30-days':
              periodLabel = '√öltimos 30 d√≠as';
              break;
            case 'custom':
              if (customDateRange) {
                const startDate = new Date(customDateRange.start).toLocaleDateString('es-MX');
                const endDate = new Date(customDateRange.end).toLocaleDateString('es-MX');
                periodLabel = startDate + ' - ' + endDate;
              } else {
                periodLabel = 'Per√≠odo Personalizado';
              }
              break;
            default:
              periodLabel = 'Per√≠odo Actual';
          }
          
          // Actualizar los labels
          document.getElementById('products-period-label').textContent = 'M√°s vendidos (' + periodLabel + ')';
          document.getElementById('orders-period-label').textContent = 'Mayor valor (' + periodLabel + ')';
        }

        // Actualizar contadores de estados
        function updateStatusCounters(statusBreakdown) {
          document.getElementById('count-completed').textContent = statusBreakdown.completed || 0;
          document.getElementById('count-delivered').textContent = statusBreakdown.delivered || 0;
          document.getElementById('count-processing').textContent = statusBreakdown.processing || 0;
          document.getElementById('count-on-hold').textContent = statusBreakdown['on-hold'] || 0;
          document.getElementById('count-pending').textContent = statusBreakdown.pending || 0;
          
          // Actualizar display de estados activos
          const activeStatuses = getActiveStatuses();
          const statusNames = {
            'completed': 'Completadas',
            'delivered': 'Entregadas', 
            'processing': 'En Proceso',
            'on-hold': 'En Espera',
            'pending': 'Pendientes'
          };
          
          const activeStatusDisplay = activeStatuses.map(s => statusNames[s]).join(', ');
          document.getElementById('active-statuses-display').textContent = activeStatusDisplay;
        }

        // Actualizar secci√≥n de cupones
        // FUNCI√ìN UNIFICADA: Actualizar secci√≥n de cupones (tradicionales + env√≠o gratis)
        function updateUnifiedCouponsSection() {
          if (!dashboardData || (!dashboardData.coupons && !dashboardData.freeShippingCoupons)) {
            document.getElementById('coupons-loading').classList.add('hidden');
            document.getElementById('coupons-empty').classList.remove('hidden');
            document.getElementById('coupons-grid').classList.add('hidden');
            document.getElementById('coupons-summary').classList.add('hidden');
            return;
          }
          
          const couponsData = dashboardData.coupons || { couponsUsed: [], totalAmount: 0, totalOrders: 0 };
          const freeShippingData = dashboardData.freeShippingCoupons || { couponsBreakdown: [], totalRealCost: 0, totalOrders: 0 };
          const comparative = dashboardData.comparative;
          
          // Ocultar loading
          document.getElementById('coupons-loading').classList.add('hidden');
          
          // Si no hay cupones de ning√∫n tipo
          if (couponsData.couponsUsed.length === 0 && freeShippingData.couponsBreakdown.length === 0) {
            document.getElementById('coupons-empty').classList.remove('hidden');
            document.getElementById('coupons-grid').classList.add('hidden');
            document.getElementById('coupons-summary').classList.add('hidden');
            // Resetear valores por defecto
            document.getElementById('total-coupons-amount').innerHTML = '$0 MXN';
            document.getElementById('total-coupons-orders').textContent = '0';
            document.getElementById('total-coupons-percentage').textContent = '0% del total de ventas';
            return;
          }
          
          // Mostrar cupones
          document.getElementById('coupons-empty').classList.add('hidden');
          document.getElementById('coupons-grid').classList.remove('hidden');
          document.getElementById('coupons-summary').classList.remove('hidden');
          
          // Filtrar cupones tradicionales (excluir c√≥digos de env√≠o gratis)
          // NOTA: 'guiapropia' ahora aparece como cup√≥n tradicional (cliente paga su propio env√≠o)
          const freeShippingCodes = ['enviodist', 'env√≠o gratis', 'envio gratis', 'free_shipping'];
          const traditionalCoupons = couponsData.couponsUsed.filter(coupon => 
            !freeShippingCodes.includes(coupon.code.toLowerCase())
          );
          
          // Generar HTML para cupones tradicionales
          const traditionalCouponsHTML = traditionalCoupons.map((coupon, index) => {
            const bgColors = [
              'from-orange-50 to-red-50 border-orange-100',
              'from-amber-50 to-yellow-50 border-amber-100',
              'from-rose-50 to-pink-50 border-rose-100',
              'from-violet-50 to-purple-50 border-violet-100',
              'from-cyan-50 to-blue-50 border-cyan-100'
            ];
            const iconColors = [
              'bg-orange-500',
              'bg-amber-500', 
              'bg-rose-500',
              'bg-violet-500',
              'bg-cyan-500'
            ];
            const textColors = [
              'text-orange-600 bg-orange-100',
              'text-amber-600 bg-amber-100',
              'text-rose-600 bg-rose-100', 
              'text-violet-600 bg-violet-100',
              'text-cyan-600 bg-cyan-100'
            ];
            
            const colorIndex = index % bgColors.length;
            
            return `
              <div class="bg-gradient-to-r ${bgColors[colorIndex]} rounded-xl p-4 border">
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center space-x-2">
                    <div class="p-2 rounded-lg ${iconColors[colorIndex]}">
                      <i class="fas fa-tag text-sm text-white"></i>
                    </div>
                    <div>
                      <p class="text-xs font-medium text-gray-600">Cup√≥n Descuento</p>
                      <p class="text-sm font-bold text-gray-900 break-all">${coupon.code}</p>
                    </div>
                  </div>
                  <span class="text-xs font-bold ${textColors[colorIndex]} px-2 py-1 rounded-full">${coupon.percentage}%</span>
                </div>
                <div class="space-y-1">
                  <div class="flex items-center justify-between">
                    <p class="text-xs text-gray-500">Total descontado:</p>
                    <p class="text-sm font-bold text-gray-900">${formatCurrency(coupon.totalDiscount)}</p>
                  </div>
                  <div class="flex items-center justify-between">
                    <p class="text-xs text-gray-500">√ìrdenes:</p>
                    <p class="text-sm font-medium text-gray-700">${coupon.ordersCount}</p>
                  </div>
                  <div class="flex items-center justify-between">
                    <p class="text-xs text-gray-500">Promedio/orden:</p>
                    <p class="text-sm font-medium text-gray-700">${formatCurrency(coupon.avgDiscountPerOrder)}</p>
                  </div>
                </div>
              </div>
            `;
          }).join('');
          
          // Generar HTML para cupones de env√≠o gratis
          const freeShippingCouponsHTML = freeShippingData.couponsBreakdown.map((coupon, index) => {
            const bgColors = [
              'from-red-50 to-pink-50 border-red-100',
              'from-purple-50 to-indigo-50 border-purple-100',
              'from-blue-50 to-cyan-50 border-blue-100',
              'from-green-50 to-emerald-50 border-green-100'
            ];
            const iconColors = [
              'bg-red-500',
              'bg-purple-500', 
              'bg-blue-500',
              'bg-green-500'
            ];
            
            const colorIndex = index % bgColors.length;
            
            return `
              <div class="bg-gradient-to-r ${bgColors[colorIndex]} rounded-xl p-4 border">
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center space-x-2">
                    <div class="p-2 rounded-lg ${iconColors[colorIndex]}">
                      <i class="fas fa-shipping-fast text-sm text-white"></i>
                    </div>
                    <div>
                      <p class="text-xs font-medium text-gray-600">Env√≠o Gratis</p>
                      <p class="text-sm font-bold text-gray-900 break-all">${coupon.code}</p>
                    </div>
                  </div>
                  <span class="text-xs font-bold text-red-600 bg-red-100 px-2 py-1 rounded-full">COSTO REAL</span>
                </div>
                <div class="space-y-1">
                  <div class="flex items-center justify-between">
                    <p class="text-xs text-gray-500">Costo absorbido:</p>
                    <p class="text-sm font-bold text-red-600">${formatCurrency(coupon.totalRealCost)}</p>
                  </div>
                  <div class="flex items-center justify-between">
                    <p class="text-xs text-gray-500">√ìrdenes:</p>
                    <p class="text-sm font-medium text-gray-700">${coupon.ordersCount}</p>
                  </div>
                  <div class="flex items-center justify-between">
                    <p class="text-xs text-gray-500">Promedio/orden:</p>
                    <p class="text-sm font-medium text-gray-700">${formatCurrency(coupon.avgCostPerOrder)}</p>
                  </div>
                </div>
              </div>
            `;
          }).join('');
          
          // Combinar ambos tipos de cupones
          document.getElementById('coupons-grid').innerHTML = traditionalCouponsHTML + freeShippingCouponsHTML;
          
          // Calcular totales combinados
          const totalDiscountAmount = couponsData.totalAmount || 0;
          const totalFreeShippingCost = freeShippingData.totalRealCost || 0;
          const totalCombinedImpact = totalDiscountAmount + totalFreeShippingCost;
          const totalCombinedOrders = (couponsData.totalOrders || 0) + (freeShippingData.totalOrders || 0);
          
          // Calcular porcentaje del total de ventas
          const totalSales = dashboardData.totalSales30Days || dashboardData.revenue || 0;
          const percentageOfSales = totalSales > 0 ? ((totalCombinedImpact / totalSales) * 100).toFixed(1) : '0';
          
          // Actualizar resumen con datos combinados
          document.getElementById('total-coupons-amount').innerHTML = `
            <div>
              <div class="text-xl font-bold text-gray-900">${formatCurrency(totalCombinedImpact)} MXN</div>
              <div class="text-xs text-gray-500 mt-1">
                <span class="text-orange-600">Descuentos: ${formatCurrency(totalDiscountAmount)}</span> ‚Ä¢ 
                <span class="text-red-600">Env√≠o gratis: ${formatCurrency(totalFreeShippingCost)}</span>
              </div>
              <div class="text-xs font-medium text-blue-600 mt-1">
                ${percentageOfSales}% del total de ventas
              </div>
            </div>
          `;
          document.getElementById('total-coupons-orders').textContent = formatNumber(totalCombinedOrders);
          
          // Usar la variable totalSales ya declarada arriba
          const percentageOfSales2 = totalSales > 0 ? ((totalCombinedImpact / totalSales) * 100).toFixed(1) : '0';
          document.getElementById('total-coupons-percentage').textContent = percentageOfSales2 + '% del total de ventas';
          
          // Mostrar indicador comparativo si disponible
          if (comparative && comparative.coupons) {
            document.getElementById('total-coupons-change').innerHTML = formatPercentageChange(comparative.coupons.amountChange);
          } else {
            document.getElementById('total-coupons-change').innerHTML = '';
          }
        }

        // FUNCI√ìN ACTUALIZADA: Actualizar secci√≥n de costos de env√≠o reales
        function updateShippingCostsSection() {
          if (!dashboardData || !dashboardData.shippingCosts) {
            // Si no hay datos, mostrar valores por defecto solo en elementos que existen
            const totalRealElement = document.getElementById('shipping-total-real');
            if (totalRealElement) totalRealElement.textContent = '$0 MXN';
            
            const ordersFoundElement = document.getElementById('shipping-orders-found');
            if (ordersFoundElement) ordersFoundElement.textContent = '0 env√≠os encontrados';
            
            const avgRealElement = document.getElementById('shipping-avg-real');
            if (avgRealElement) avgRealElement.textContent = 'Promedio: $0';

            const topCostElement = document.getElementById('shipping-top-cost');
            if (topCostElement) topCostElement.textContent = '$0';
            
            const topOrderElement = document.getElementById('shipping-top-order');
            if (topOrderElement) topOrderElement.textContent = 'Orden: -';
            
            const topCarrierElement = document.getElementById('shipping-top-carrier');
            if (topCarrierElement) topCarrierElement.textContent = '-';
            
            return;
          }
          
          const shippingData = dashboardData.shippingCosts;
          
          // Costo Real Total - solo actualizar si los elementos existen
          const totalRealElement = document.getElementById('shipping-total-real');
          if (totalRealElement) totalRealElement.textContent = formatCurrency(shippingData.totalRealCost);
          
          const ordersFoundElement = document.getElementById('shipping-orders-found');
          if (ordersFoundElement) ordersFoundElement.textContent = shippingData.found + ' env√≠os encontrados';
          
          const avgRealElement = document.getElementById('shipping-avg-real');
          if (avgRealElement) avgRealElement.textContent = 'Promedio: ' + formatCurrency(shippingData.avgRealCost);

          // Top Env√≠o - solo actualizar si los elementos existen
          if (shippingData.topShipments && shippingData.topShipments.length > 0) {
            const topShipment = shippingData.topShipments[0];
            
            const topCostElement = document.getElementById('shipping-top-cost');
            if (topCostElement) topCostElement.textContent = formatCurrency(topShipment.realCost);
            
            const topOrderElement = document.getElementById('shipping-top-order');
            if (topOrderElement) topOrderElement.textContent = 'Orden: #' + topShipment.orderId;
            
            const topCarrierElement = document.getElementById('shipping-top-carrier');
            if (topCarrierElement) topCarrierElement.textContent = topShipment.carrier;
          }
        }

        // FUNCI√ìN SIMPLIFICADA: Actualizar secci√≥n de insights de env√≠o (solo top orders)
        function updateShippingInsightsSection() {
          if (!dashboardData || !dashboardData.freeShippingCoupons) {
            // Si no hay datos, mostrar mensaje por defecto solo en top orders
            const topOrdersElement = document.getElementById('top-free-shipping-orders');
            if (topOrdersElement) {
              topOrdersElement.innerHTML = '<p class="text-gray-500 text-sm">No hay datos de env√≠os gratis en este per√≠odo</p>';
            }
            return;
          }
          
          const freeShippingData = dashboardData.freeShippingCoupons || {};
          
          // Top √ìrdenes Costosas
          if (freeShippingData.topFreeShippingOrders && freeShippingData.topFreeShippingOrders.length > 0) {
            const topOrdersHTML = freeShippingData.topFreeShippingOrders.map((order, index) => {
              return `
                <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-red-100">
                  <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0">
                      <span class="inline-flex items-center justify-center w-8 h-8 bg-red-100 text-red-600 rounded-full text-sm font-bold">
                        ${index + 1}
                      </span>
                    </div>
                    <div>
                      <p class="text-sm font-medium text-gray-900">Orden #${order.orderId}</p>
                      <p class="text-xs text-gray-500">${order.customerEmail}</p>
                      <p class="text-xs text-red-600">${order.couponCodes.join(', ')}</p>
                    </div>
                  </div>
                  <div class="text-right">
                    <p class="text-sm font-bold text-red-600">${formatCurrency(order.realCost)}</p>
                    <p class="text-xs text-gray-500">Orden: ${formatCurrency(order.orderTotal)}</p>
                  </div>
                </div>
              `;
            }).join('');
            
            document.getElementById('top-free-shipping-orders').innerHTML = topOrdersHTML;
          } else {
            document.getElementById('top-free-shipping-orders').innerHTML = '<p class="text-gray-500 text-sm">No hay √≥rdenes de env√≠o gratis en este per√≠odo</p>';
          }
        }

        // Funci√≥n para reintentar conexi√≥n
        function retryConnection() {
          document.getElementById('error').classList.add('hidden');
          loadDashboard();
        }

        // Funciones de chat
        function enableChat() {
          document.getElementById('chat-input').disabled = false;
          document.getElementById('chat-send').disabled = false;
        }

        function setChatMessage(message) {
          document.getElementById('chat-input').value = message;
        }

        function handleChatKeyPress(event) {
          if (event.key === 'Enter') {
            sendChatMessage();
          }
        }

        async function sendChatMessage() {
          const input = document.getElementById('chat-input');
          const message = input.value.trim();
          
          if (!message) return;
          
          const messagesContainer = document.getElementById('chat-messages');
          
          // Mostrar mensaje del usuario
          const userMessage = document.createElement('div');
          userMessage.className = 'flex justify-end';
          userMessage.innerHTML = `
            <div class="bg-purple-500 text-white px-4 py-2 rounded-lg max-w-xs">
              <p class="text-sm">${message}</p>
            </div>
          `;
          messagesContainer.appendChild(userMessage);
          
          // Limpiar input
          input.value = '';
          
          // Mostrar indicador de escritura
          const typingIndicator = document.createElement('div');
          typingIndicator.className = 'flex justify-start';
          typingIndicator.innerHTML = `
            <div class="bg-gray-200 px-4 py-2 rounded-lg">
              <p class="text-sm text-gray-600">
                <i class="fas fa-circle animate-pulse"></i>
                <i class="fas fa-circle animate-pulse" style="animation-delay: 0.2s;"></i>
                <i class="fas fa-circle animate-pulse" style="animation-delay: 0.4s;"></i>
                Analizando...
              </p>
            </div>
          `;
          messagesContainer.appendChild(typingIndicator);
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
          
          try {
            // Usar axios que ya tiene configurado el Authorization header
            const response = await axios.post('/api/chat', { message });
            const result = response.data;
            
            // Remover indicador de escritura
            messagesContainer.removeChild(typingIndicator);
            
            if (result.success) {
              // Mostrar respuesta de la IA
              const aiMessage = document.createElement('div');
              aiMessage.className = 'flex justify-start';
              aiMessage.innerHTML = `
                <div class="bg-white border border-gray-200 px-4 py-3 rounded-lg max-w-md shadow-sm">
                  <div class="flex items-center space-x-2 mb-2">
                    <i class="fas fa-robot text-purple-500"></i>
                    <span class="text-xs text-gray-500 font-medium">Analista IA</span>
                    <span class="text-xs text-gray-400">‚Ä¢ ${result.data.executionTime}ms</span>
                  </div>
                  <div class="text-sm text-gray-800 whitespace-pre-wrap">${result.data.response}</div>
                </div>
              `;
              messagesContainer.appendChild(aiMessage);
            } else {
              // Mostrar error
              const errorMessage = document.createElement('div');
              errorMessage.className = 'flex justify-start';
              errorMessage.innerHTML = `
                <div class="bg-red-50 border border-red-200 px-4 py-2 rounded-lg max-w-xs">
                  <p class="text-sm text-red-600">Error: ${result.error}</p>
                </div>
              `;
              messagesContainer.appendChild(errorMessage);
            }
            
          } catch (error) {
            // Remover indicador de escritura
            messagesContainer.removeChild(typingIndicator);
            
            // Mostrar error de conexi√≥n
            const errorMessage = document.createElement('div');
            errorMessage.className = 'flex justify-start';
            errorMessage.innerHTML = `
              <div class="bg-red-50 border border-red-200 px-4 py-2 rounded-lg max-w-xs">
                <p class="text-sm text-red-600">Error de conexi√≥n. Intenta de nuevo.</p>
              </div>
            `;
            messagesContainer.appendChild(errorMessage);
          }
          
          // Scroll al final
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Funci√≥n para verificar autenticaci√≥n
        function checkAuthentication() {
          const token = localStorage.getItem('auth_token');
          if (!token) {
            window.location.href = '/login';
            return false;
          }
          
          // Configurar axios para usar el token autom√°ticamente
          axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
          return true;
        }

        // Verificar token con el servidor
        async function verifyTokenWithServer() {
          const token = localStorage.getItem('auth_token');
          if (!token) {
            window.location.href = '/login';
            return false;
          }

          try {
            const response = await axios.post('/api/verify-token', {}, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.data.success) {
              return true;
            } else {
              localStorage.removeItem('auth_token');
              localStorage.removeItem('user_info');
              window.location.href = '/login';
              return false;
            }
          } catch (error) {
            console.error('Error verificando token:', error);
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_info');
            window.location.href = '/login';
            return false;
          }
        }

        // Inicializar informaci√≥n del usuario
        function initializeUserInfo() {
          const userInfo = localStorage.getItem('user_info');
          if (userInfo) {
            try {
              const user = JSON.parse(userInfo);
              
              // Actualizar nombre del usuario en ambos headers (desktop y m√≥vil)
              const userNameElement = document.getElementById('user-name');
              const userNameMobileElement = document.getElementById('user-name-mobile');
              
              if (userNameElement) {
                userNameElement.textContent = user.name || 'Usuario';
              }
              if (userNameMobileElement) {
                userNameMobileElement.textContent = user.name || 'Usuario';
              }
              
              // Mostrar bot√≥n de gesti√≥n de usuarios solo para administradores (desktop y m√≥vil)
              const adminBtn = document.getElementById('admin-users-btn');
              const adminBtnMobile = document.getElementById('admin-users-btn-mobile');
              
              if (user.role === 'admin') {
                if (adminBtn) adminBtn.classList.remove('hidden');
                if (adminBtnMobile) adminBtnMobile.classList.remove('hidden');
                console.log('Botones de administraci√≥n mostrados para:', user.name);
              }
              
              console.log('Usuario inicializado:', user.name, 'Role:', user.role);
            } catch (error) {
              console.error('Error parsing user info:', error);
            }
          }
        }

        // Inicializar dashboard al cargar la p√°gina
        window.addEventListener('DOMContentLoaded', async () => {
          console.log('Dashboard iniciando...');
          
          // Verificar si hay token
          const token = localStorage.getItem('auth_token');
          if (!token) {
            console.log('No hay token, redirigiendo al login');
            window.location.href = '/login';
            return;
          }

          // CR√çTICO: Verificar si el token est√° expirado antes de usarlo
          if (isTokenExpired(token)) {
            console.log('Token expirado detectado, limpiando y redirigiendo...');
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_info');
            // Mostrar mensaje por 2 segundos antes de redirigir
            document.body.innerHTML = '<div style="text-align:center; margin-top:50px; font-family:Arial;"><h2>üîÑ Token expirado</h2><p>Redirigiendo al login...</p></div>';
            setTimeout(() => {
              window.location.href = '/login';
            }, 2000);
            return;
          }

          console.log('Token v√°lido encontrado:', token.substring(0, 50) + '...');
          
          // Configurar axios con el token
          axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
          
          // Configurar interceptor de respuesta para manejar errores de token autom√°ticamente
          axios.interceptors.response.use(
            response => response,
            error => {
              console.error('Axios interceptor - Error detectado:', error);
              
              // Verificar si es error de token
              const isTokenError = (
                (error.response && error.response.status === 401) ||
                (error.response && error.response.data && error.response.data.error && 
                 (error.response.data.error.includes('Token') || 
                  error.response.data.error.includes('token') ||
                  error.response.data.error.includes('inv√°lido') ||
                  error.response.data.error.includes('expirado')))
              );
              
              if (isTokenError) {
                console.log('Interceptor - Token inv√°lido detectado, limpiando y redirigiendo');
                localStorage.clear();
                delete axios.defaults.headers.common['Authorization'];
                window.location.href = '/login';
                return Promise.reject(new Error('Token inv√°lido - Redirigiendo al login'));
              }
              
              return Promise.reject(error);
            }
          );
          
          // Inicializar informaci√≥n del usuario
          initializeUserInfo();
          
          // Inicializar checkbox de comparaci√≥n y texto
          const comparisonCheckbox = document.getElementById('enable-comparison');
          if (comparisonCheckbox) {
            comparisonCheckbox.checked = comparisonEnabled;
            updateComparisonPeriodText();
          }
          
          // Verificar token con el servidor antes de cargar dashboard
          const isValidToken = await verifyTokenWithServer();
          if (!isValidToken) {
            return; // verifyTokenWithServer ya maneja la redirecci√≥n
          }
          
          // Intentar cargar dashboard directamente
          console.log('Token v√°lido, cargando dashboard...');
          await loadDashboard();
          
          // Cargar datos de Google Analytics 4
          console.log('Cargando datos de Google Analytics 4...');
          await loadAnalytics();
          
          // Cargar datos de Google Ads
          console.log('Cargando datos de Google Ads...');
          await loadGoogleAds();
        });
        
        // === GESTI√ìN DE USUARIOS ===
        
        let currentUsers = [];
        
        // Abrir modal de gesti√≥n de usuarios
        function openUserManagement() {
          document.getElementById('user-management-modal').classList.remove('hidden');
          loadUsers();
        }
        
        // Cerrar modal
        function closeUserManagement() {
          document.getElementById('user-management-modal').classList.add('hidden');
        }
        
        // Cargar lista de usuarios
        async function loadUsers() {
          try {
            const response = await axios.get('/api/users');
            currentUsers = response.data.users;
            renderUsersList();
          } catch (error) {
            console.error('Error cargando usuarios:', error);
            showUserMessage('Error cargando usuarios', 'error');
          }
        }
        
        // Renderizar lista de usuarios
        function renderUsersList() {
          const usersList = document.getElementById('users-list');
          usersList.innerHTML = '';
          
          currentUsers.forEach(user => {
            const userRow = document.createElement('div');
            userRow.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200';
            
            const statusBadge = user.isActive ? 
              '<span class="text-xs font-medium text-green-600 bg-green-100 px-2 py-1 rounded-full">Activo</span>' :
              '<span class="text-xs font-medium text-red-600 bg-red-100 px-2 py-1 rounded-full">Inactivo</span>';
              
            const roleBadge = user.role === 'admin' ?
              '<span class="text-xs font-medium text-purple-600 bg-purple-100 px-2 py-1 rounded-full">Admin</span>' :
              '<span class="text-xs font-medium text-blue-600 bg-blue-100 px-2 py-1 rounded-full">Usuario</span>';
            
            userRow.innerHTML = `
              <div class="flex-1">
                <div class="flex items-center space-x-3">
                  <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-cyan-600 rounded-full flex items-center justify-center">
                    <span class="text-white font-bold text-sm">${user.name.charAt(0).toUpperCase()}</span>
                  </div>
                  <div>
                    <p class="font-semibold text-gray-800">${user.name}</p>
                    <p class="text-sm text-gray-600">${user.email}</p>
                    <p class="text-xs text-gray-500">Creado: ${new Date(user.createdAt).toLocaleDateString('es-MX')}</p>
                  </div>
                </div>
              </div>
              <div class="flex items-center space-x-2">
                ${roleBadge}
                ${statusBadge}
                ${user.role !== 'admin' ? `<button onclick="deleteUser(${user.id})" class="text-red-600 hover:text-red-800 p-2"><i class="fas fa-trash text-sm"></i></button>` : ''}
              </div>
            `;
            
            usersList.appendChild(userRow);
          });
          
          // Actualizar contador
          document.getElementById('users-count').textContent = `${currentUsers.length}/5 usuarios`;
        }
        
        // Agregar nuevo usuario
        async function addUser() {
          const name = document.getElementById('new-user-name').value.trim();
          const email = document.getElementById('new-user-email').value.trim();
          const password = document.getElementById('new-user-password').value;
          
          if (!name || !email || !password) {
            showUserMessage('Todos los campos son obligatorios', 'error');
            return;
          }
          
          if (password.length < 6) {
            showUserMessage('La contrase√±a debe tener al menos 6 caracteres', 'error');
            return;
          }
          
          try {
            const response = await axios.post('/api/users', {
              name: name,
              email: email,
              password: password,
              role: 'user'
            });
            
            if (response.data.success) {
              showUserMessage('Usuario agregado correctamente', 'success');
              // Limpiar formulario
              document.getElementById('new-user-name').value = '';
              document.getElementById('new-user-email').value = '';
              document.getElementById('new-user-password').value = '';
              // Recargar lista
              loadUsers();
            } else {
              showUserMessage(response.data.message || 'Error agregando usuario', 'error');
            }
          } catch (error) {
            console.error('Error:', error);
            showUserMessage('Error de conexi√≥n', 'error');
          }
        }
        
        // Eliminar usuario
        async function deleteUser(userId) {
          if (!confirm('¬øEst√°s seguro de que quieres eliminar este usuario?')) {
            return;
          }
          
          try {
            const response = await axios.delete(`/api/users/${userId}`);
            
            if (response.data.success) {
              showUserMessage('Usuario eliminado correctamente', 'success');
              loadUsers();
            } else {
              showUserMessage(response.data.message || 'Error eliminando usuario', 'error');
            }
          } catch (error) {
            console.error('Error:', error);
            showUserMessage('Error de conexi√≥n', 'error');
          }
        }
        
        // Funci√≥n de logout
        async function logout() {
          try {
            console.log('Iniciando logout...');
            
            // Limpiar datos locales inmediatamente
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_info');
            
            // Opcional: llamar al endpoint de logout
            try {
              await axios.post('/api/logout');
              console.log('Logout API exitoso');
            } catch (error) {
              console.log('Error en logout API (no cr√≠tico):', error);
            }
            
            // Limpiar headers de axios
            delete axios.defaults.headers.common['Authorization'];
            
            console.log('Redirigiendo al login...');
            // Redirigir al login
            window.location.href = '/login';
            
          } catch (error) {
            console.error('Error durante logout:', error);
            // Forzar logout aunque haya error
            localStorage.clear();
            window.location.replace('/login');
          }
        }
        
        // Funci√≥n alternativa de logout (por si falla la principal)
        function forceLogout() {
          localStorage.clear();
          sessionStorage.clear();
          window.location.replace('/login');
        }
        
        // Mostrar mensajes en el modal de usuarios
        function showUserMessage(message, type) {
          const messageDiv = document.getElementById('user-message');
          messageDiv.textContent = message;
          messageDiv.className = `p-3 rounded-lg text-sm font-medium ${type === 'error' ? 'bg-red-100 text-red-700 border border-red-200' : 'bg-green-100 text-green-700 border border-green-200'}`;
          messageDiv.classList.remove('hidden');
          
          setTimeout(() => {
            messageDiv.classList.add('hidden');
          }, 5000);
        }
        </script>
        
        <!-- Modal de Gesti√≥n de Usuarios -->
        <div id="user-management-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
          <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-600 to-cyan-600 p-6 rounded-t-xl">
              <div class="flex items-center justify-between">
                <div>
                  <h2 class="text-2xl font-bold text-white">Gesti√≥n de Usuarios</h2>
                  <p class="text-blue-100 text-sm mt-1">Administrar acceso al dashboard</p>
                </div>
                <button onclick="closeUserManagement()" class="text-white hover:text-gray-200 text-2xl">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
            
            <!-- Content -->
            <div class="p-6">
              <!-- Message -->
              <div id="user-message" class="hidden mb-4"></div>
              
              <!-- Stats -->
              <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <div class="flex items-center justify-between">
                  <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-blue-500 rounded-lg flex items-center justify-center">
                      <i class="fas fa-users text-white text-xl"></i>
                    </div>
                    <div>
                      <p id="users-count" class="text-lg font-semibold text-gray-800">0/5 usuarios</p>
                      <p class="text-sm text-gray-600">L√≠mite m√°ximo: 5 usuarios</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Add User Form -->
              <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                  <i class="fas fa-user-plus mr-2 text-green-600"></i>
                  Agregar Nuevo Usuario
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo</label>
                    <input type="text" id="new-user-name" placeholder="Marco Serrano" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="new-user-email" placeholder="usuario@adaptoheal.com" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Contrase√±a</label>
                    <input type="password" id="new-user-password" placeholder="M√≠nimo 6 caracteres" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                  </div>
                </div>
                
                <button onclick="addUser()" 
                        class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-6 py-2 rounded-lg font-medium hover:from-green-600 hover:to-blue-600 transition-all">
                  <i class="fas fa-plus mr-2"></i>Agregar Usuario
                </button>
              </div>
              
              <!-- Users List -->
              <div>
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                  <i class="fas fa-list mr-2 text-blue-600"></i>
                  Usuarios Actuales
                </h3>
                
                <div id="users-list" class="space-y-3">
                  <!-- Los usuarios se cargan aqu√≠ din√°micamente -->
                </div>
              </div>
            </div>
            
            <!-- Footer -->
            <div class="bg-gray-50 px-6 py-4 rounded-b-xl">
              <div class="flex justify-between items-center">
                <p class="text-sm text-gray-600">
                  <i class="fas fa-info-circle mr-1"></i>
                  Todos los usuarios tienen acceso de solo lectura al dashboard
                </p>
                <button onclick="closeUserManagement()" 
                        class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                  Cerrar
                </button>
              </div>
            </div>
          </div>
        </div>
    </body>
    </html>
  