<!DOCTYPE html>
<html>
<head>
    <title>Simulación de Usuario - Adaptoheal Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; overflow: auto; }
    </style>
</head>
<body>
    <h1>🧪 Simulación Completa de Usuario - Adaptoheal Analytics</h1>
    
    <div class="test-section">
        <h3>📋 Resultados de las Pruebas</h3>
        <div id="results"></div>
    </div>
    
    <div class="test-section">
        <button onclick="runFullTest()">🚀 Ejecutar Pruebas Completas</button>
    </div>

    <script>
        let authToken = null;
        const baseUrl = window.location.origin;
        
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            results.appendChild(div);
            console.log(message);
        }
        
        async function testLogin() {
            log('🔐 PASO 1: Probando login con credenciales marco@serrano.marketing / Adaptoheal2025!');
            try {
                const response = await axios.post(`${baseUrl}/api/login`, {
                    email: 'marco@serrano.marketing',
                    password: 'Adaptoheal2025!'
                });
                
                if (response.data.success) {
                    authToken = response.data.token;
                    log(`✅ Login exitoso! Usuario: ${response.data.user.name} (${response.data.user.role})`, 'success');
                    
                    // Configurar axios para usar el token automáticamente
                    axios.defaults.headers.common['Authorization'] = `Bearer ${authToken}`;
                    return true;
                } else {
                    log(`❌ Error en login: ${response.data.message}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`❌ Error de conexión en login: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function testDashboardData() {
            log('📊 PASO 2: Probando carga de datos del dashboard...');
            try {
                const response = await axios.get(`${baseUrl}/api/dashboard?period=august-september-2025&enableComparison=true`);
                
                if (response.data.success) {
                    const data = response.data.data;
                    log(`✅ Datos del dashboard cargados correctamente!`, 'success');
                    log(`💰 Productos top encontrados: ${data.topProducts?.length || 0}`, 'info');
                    log(`📈 Top product: ${data.topProducts?.[0]?.name || 'N/A'}`, 'info');
                    log(`📋 Debug info: ${JSON.stringify(response.data.debug.periodInfo, null, 2)}`, 'info');
                    return true;
                } else {
                    log(`❌ Error cargando dashboard: ${response.data.error}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`❌ Error de conexión dashboard: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function testChat() {
            log('🤖 PASO 3: Probando chat IA...');
            try {
                const response = await axios.post(`${baseUrl}/api/chat`, {
                    message: '¿Cuál es el producto más vendido?'
                });
                
                if (response.data.success) {
                    log(`✅ Chat IA respondió correctamente!`, 'success');
                    log(`🗨️ Respuesta: ${response.data.data.response.substring(0, 200)}...`, 'info');
                    return true;
                } else {
                    log(`❌ Error en chat: ${response.data.error}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`❌ Error de conexión chat: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function testUserManagement() {
            log('👥 PASO 4: Probando gestión de usuarios (admin)...');
            try {
                const response = await axios.get(`${baseUrl}/api/users`);
                
                if (response.data.success) {
                    log(`✅ Lista de usuarios obtenida!`, 'success');
                    log(`👤 Usuarios activos: ${response.data.users.filter(u => u.isActive).length}`, 'info');
                    log(`👤 Total usuarios: ${response.data.users.length}`, 'info');
                    return true;
                } else {
                    log(`❌ Error obteniendo usuarios: ${response.data.error}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`❌ Error de conexión usuarios: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function testLogout() {
            log('🚪 PASO 5: Probando logout...');
            try {
                const response = await axios.post(`${baseUrl}/api/logout`);
                log(`✅ Logout ejecutado`, 'success');
                authToken = null;
                delete axios.defaults.headers.common['Authorization'];
                return true;
            } catch (error) {
                log(`⚠️ Error en logout (normal): ${error.message}`, 'info');
                return true; // El logout siempre se considera exitoso
            }
        }
        
        async function runFullTest() {
            log('🎬 INICIANDO SIMULACIÓN COMPLETA DE USUARIO...', 'info');
            
            const results = {
                login: await testLogin(),
                dashboard: false,
                chat: false,
                users: false,
                logout: false
            };
            
            if (results.login) {
                results.dashboard = await testDashboardData();
                results.chat = await testChat();
                results.users = await testUserManagement();
                results.logout = await testLogout();
            }
            
            log('📊 RESUMEN FINAL DE PRUEBAS:', 'info');
            log(`🔐 Login: ${results.login ? '✅' : '❌'}`, results.login ? 'success' : 'error');
            log(`📊 Dashboard: ${results.dashboard ? '✅' : '❌'}`, results.dashboard ? 'success' : 'error');
            log(`🤖 Chat IA: ${results.chat ? '✅' : '❌'}`, results.chat ? 'success' : 'error');
            log(`👥 Usuarios: ${results.users ? '✅' : '❌'}`, results.users ? 'success' : 'error');
            log(`🚪 Logout: ${results.logout ? '✅' : '❌'}`, results.logout ? 'success' : 'error');
            
            const successCount = Object.values(results).filter(r => r).length;
            const totalTests = Object.keys(results).length;
            
            if (successCount === totalTests) {
                log(`🎉 TODAS LAS PRUEBAS PASARON! (${successCount}/${totalTests})`, 'success');
            } else {
                log(`⚠️ ${successCount}/${totalTests} pruebas pasaron. Revisar errores arriba.`, 'error');
            }
        }
        
        // Ejecutar pruebas automáticamente al cargar
        window.onload = () => {
            setTimeout(runFullTest, 1000);
        };
    </script>
</body>
</html>