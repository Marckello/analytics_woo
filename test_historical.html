<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba Datos Hist√≥ricos - Adaptoheal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-4">
                üìä Prueba de Datos Hist√≥ricos Excel
            </h1>
            <p class="text-gray-600 mb-6">
                Esta es una prueba directa del procesamiento de datos hist√≥ricos desde el Excel <code>data_shopify.xls</code>
            </p>
            
            <div class="flex space-x-4 mb-6">
                <button onclick="testHistoricalData('2025-01-01', '2025-06-30')" 
                        class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    üìä Prueba: Primer Semestre 2025
                </button>
                <button onclick="testHistoricalData('2024-01-01', '2024-12-31')" 
                        class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    üìä Prueba: Todo 2024
                </button>
                <button onclick="testHistoricalData('2020-01-01', '2025-07-31')" 
                        class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    üöÄ Prueba: Todo el Hist√≥rico
                </button>
            </div>
            
            <div id="loading" class="hidden">
                <div class="flex items-center justify-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-4 border-blue-500 border-t-transparent"></div>
                    <span class="ml-3 text-gray-600">Procesando datos hist√≥ricos...</span>
                </div>
            </div>
            
            <div id="results" class="hidden">
                <h2 class="text-xl font-bold text-gray-800 mb-4">üìà Resultados</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <h3 class="text-green-800 font-medium">üí∞ Revenue Total</h3>
                        <p id="total-revenue" class="text-2xl font-bold text-green-600">$0</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h3 class="text-blue-800 font-medium">üì¶ Total √ìrdenes</h3>
                        <p id="total-orders" class="text-2xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <h3 class="text-purple-800 font-medium">üéØ Ticket Promedio</h3>
                        <p id="avg-order" class="text-2xl font-bold text-purple-600">$0</p>
                    </div>
                </div>
                
                <h3 class="text-lg font-bold text-gray-800 mb-4">üõçÔ∏è √öltimas 10 √ìrdenes</h3>
                <div id="orders-list" class="space-y-2"></div>
            </div>
            
            <div id="error" class="hidden bg-red-50 border border-red-200 rounded-lg p-4">
                <h3 class="text-red-800 font-medium mb-2">‚ùå Error</h3>
                <p id="error-message" class="text-red-600"></p>
            </div>
        </div>
        
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <h3 class="text-yellow-800 font-medium mb-2">‚ÑπÔ∏è Informaci√≥n T√©cnica</h3>
            <ul class="text-yellow-700 text-sm space-y-1">
                <li>‚úÖ <strong>Procesador Python:</strong> shopify_processor.py funciona correctamente</li>
                <li>‚úÖ <strong>Excel:</strong> data_shopify.xls con 29,381 filas de datos</li>
                <li>‚úÖ <strong>Endpoint:</strong> /api/historical-data (renombrado desde /api/shopify-data)</li>
                <li>‚úÖ <strong>Funci√≥n Backend:</strong> getHistoricalDataFromExcel() procesando datos</li>
                <li>‚ùå <strong>Dashboard Principal:</strong> Error JavaScript temporalmente (no afecta procesamiento)</li>
            </ul>
        </div>
    </div>

    <script>
        async function testHistoricalData(startDate, endDate) {
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const error = document.getElementById('error');
            
            // Reset UI
            loading.classList.remove('hidden');
            results.classList.add('hidden');
            error.classList.add('hidden');
            
            try {
                console.log(`Probando datos hist√≥ricos: ${startDate} ‚Üí ${endDate}`);
                
                // Simular login para obtener token
                const loginResponse = await axios.post('/api/login', {
                    email: 'marco@serrano.marketing',
                    password: 'AdaptoHeal2024!'
                });
                
                if (!loginResponse.data.success) {
                    throw new Error('Error de autenticaci√≥n');
                }
                
                const token = loginResponse.data.token;
                
                // Hacer request con token
                const response = await axios.get('/api/historical-data', {
                    params: {
                        start_date: startDate,
                        end_date: endDate,
                        source: 'historical'
                    },
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('Respuesta del servidor:', response.data);
                
                if (response.data.statistics) {
                    showResults(response.data);
                } else {
                    throw new Error('No se recibieron estad√≠sticas v√°lidas');
                }
                
            } catch (err) {
                console.error('Error:', err);
                showError(err.response?.data?.error || err.message);
            } finally {
                loading.classList.add('hidden');
            }
        }
        
        function showResults(data) {
            const results = document.getElementById('results');
            const stats = data.statistics;
            const orders = data.orders || [];
            
            // Mostrar estad√≠sticas
            document.getElementById('total-revenue').textContent = 
                new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' })
                .format(stats.totalRevenue || 0);
            
            document.getElementById('total-orders').textContent = 
                (stats.totalOrders || 0).toLocaleString();
                
            document.getElementById('avg-order').textContent = 
                new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' })
                .format(stats.averageOrderValue || 0);
            
            // Mostrar √≥rdenes
            const ordersList = document.getElementById('orders-list');
            ordersList.innerHTML = orders.slice(0, 10).map(order => `
                <div class="bg-gray-50 p-3 rounded border flex justify-between items-center">
                    <div>
                        <p class="font-medium">Orden #${order.id}</p>
                        <p class="text-sm text-gray-600">${order.customer_email || 'Cliente'}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-green-600">
                            ${new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(order.total)}
                        </p>
                        <p class="text-sm text-gray-500">${order.status}</p>
                    </div>
                </div>
            `).join('');
            
            results.classList.remove('hidden');
        }
        
        function showError(message) {
            const error = document.getElementById('error');
            document.getElementById('error-message').textContent = message;
            error.classList.remove('hidden');
        }
    </script>
</body>
</html>